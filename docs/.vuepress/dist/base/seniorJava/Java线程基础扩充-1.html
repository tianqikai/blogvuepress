<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. Java线程基础扩充 | TQK的个人博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="TQK的个人博客">
    <meta name="author" content="冰岛红茶">
    <meta name="keywords" content="个人博客 ，java ，后端">
    
    <link rel="preload" href="/assets/css/0.styles.1404a2ef.css" as="style"><link rel="preload" href="/assets/js/app.20860f16.js" as="script"><link rel="preload" href="/assets/js/2.ac74a662.js" as="script"><link rel="preload" href="/assets/js/15.92ffb898.js" as="script"><link rel="prefetch" href="/assets/js/10.3a6dd4be.js"><link rel="prefetch" href="/assets/js/100.fd209a58.js"><link rel="prefetch" href="/assets/js/101.9e44c8c9.js"><link rel="prefetch" href="/assets/js/102.b139287e.js"><link rel="prefetch" href="/assets/js/103.85240188.js"><link rel="prefetch" href="/assets/js/104.a2411e9b.js"><link rel="prefetch" href="/assets/js/105.ec8382ca.js"><link rel="prefetch" href="/assets/js/106.ad5c898b.js"><link rel="prefetch" href="/assets/js/107.199752aa.js"><link rel="prefetch" href="/assets/js/108.79dd4578.js"><link rel="prefetch" href="/assets/js/109.c9c7dd80.js"><link rel="prefetch" href="/assets/js/11.abb57436.js"><link rel="prefetch" href="/assets/js/110.cde62a48.js"><link rel="prefetch" href="/assets/js/111.cf5cb42d.js"><link rel="prefetch" href="/assets/js/112.146a61c2.js"><link rel="prefetch" href="/assets/js/113.7ee37e11.js"><link rel="prefetch" href="/assets/js/114.9b3f86c1.js"><link rel="prefetch" href="/assets/js/115.4d3cb222.js"><link rel="prefetch" href="/assets/js/116.dc786541.js"><link rel="prefetch" href="/assets/js/117.5d2b7a43.js"><link rel="prefetch" href="/assets/js/118.555d9623.js"><link rel="prefetch" href="/assets/js/119.bcc7d4c3.js"><link rel="prefetch" href="/assets/js/12.29aa0de4.js"><link rel="prefetch" href="/assets/js/120.2b1cc8ab.js"><link rel="prefetch" href="/assets/js/121.1827f130.js"><link rel="prefetch" href="/assets/js/122.4d72e0ad.js"><link rel="prefetch" href="/assets/js/123.ce840919.js"><link rel="prefetch" href="/assets/js/124.65e7083d.js"><link rel="prefetch" href="/assets/js/125.4f2a26e2.js"><link rel="prefetch" href="/assets/js/126.adeb4bd7.js"><link rel="prefetch" href="/assets/js/127.920474e5.js"><link rel="prefetch" href="/assets/js/128.b0c5f879.js"><link rel="prefetch" href="/assets/js/129.2909f7a5.js"><link rel="prefetch" href="/assets/js/13.4ea04c52.js"><link rel="prefetch" href="/assets/js/130.f62ae5a4.js"><link rel="prefetch" href="/assets/js/131.95387586.js"><link rel="prefetch" href="/assets/js/132.b33afbd8.js"><link rel="prefetch" href="/assets/js/133.da38ae51.js"><link rel="prefetch" href="/assets/js/134.9f9f82b1.js"><link rel="prefetch" href="/assets/js/135.aefb9603.js"><link rel="prefetch" href="/assets/js/136.d15b365f.js"><link rel="prefetch" href="/assets/js/137.6d300f50.js"><link rel="prefetch" href="/assets/js/138.8a56c8ed.js"><link rel="prefetch" href="/assets/js/139.783e6d81.js"><link rel="prefetch" href="/assets/js/14.e8146ffd.js"><link rel="prefetch" href="/assets/js/140.e9f101e5.js"><link rel="prefetch" href="/assets/js/141.69184413.js"><link rel="prefetch" href="/assets/js/142.ebad6810.js"><link rel="prefetch" href="/assets/js/143.0bec2570.js"><link rel="prefetch" href="/assets/js/144.141cc77e.js"><link rel="prefetch" href="/assets/js/145.ba04243e.js"><link rel="prefetch" href="/assets/js/146.84d4c103.js"><link rel="prefetch" href="/assets/js/147.45359c39.js"><link rel="prefetch" href="/assets/js/148.9320f6c6.js"><link rel="prefetch" href="/assets/js/149.acbdb3a8.js"><link rel="prefetch" href="/assets/js/150.89a68b22.js"><link rel="prefetch" href="/assets/js/151.055f0439.js"><link rel="prefetch" href="/assets/js/152.3fd5282f.js"><link rel="prefetch" href="/assets/js/153.d5fdc2fe.js"><link rel="prefetch" href="/assets/js/154.f73c50e1.js"><link rel="prefetch" href="/assets/js/155.bed831f7.js"><link rel="prefetch" href="/assets/js/156.b3ed2e41.js"><link rel="prefetch" href="/assets/js/157.b3f7df32.js"><link rel="prefetch" href="/assets/js/158.0e03d41c.js"><link rel="prefetch" href="/assets/js/159.54fd0be8.js"><link rel="prefetch" href="/assets/js/16.fa609857.js"><link rel="prefetch" href="/assets/js/160.fca21611.js"><link rel="prefetch" href="/assets/js/161.b1cd68aa.js"><link rel="prefetch" href="/assets/js/162.d0e9c43f.js"><link rel="prefetch" href="/assets/js/163.9004f0df.js"><link rel="prefetch" href="/assets/js/164.96189f49.js"><link rel="prefetch" href="/assets/js/165.7cd30d2e.js"><link rel="prefetch" href="/assets/js/166.5360db63.js"><link rel="prefetch" href="/assets/js/167.ef897b46.js"><link rel="prefetch" href="/assets/js/17.631a4a3d.js"><link rel="prefetch" href="/assets/js/18.f7f233f4.js"><link rel="prefetch" href="/assets/js/19.1d041b8d.js"><link rel="prefetch" href="/assets/js/20.b740ed31.js"><link rel="prefetch" href="/assets/js/21.8443775b.js"><link rel="prefetch" href="/assets/js/22.88937921.js"><link rel="prefetch" href="/assets/js/23.e40252e7.js"><link rel="prefetch" href="/assets/js/24.ca8ee3b0.js"><link rel="prefetch" href="/assets/js/25.85e99c48.js"><link rel="prefetch" href="/assets/js/26.91a01e17.js"><link rel="prefetch" href="/assets/js/27.f0878d57.js"><link rel="prefetch" href="/assets/js/28.88e8d379.js"><link rel="prefetch" href="/assets/js/29.760dd747.js"><link rel="prefetch" href="/assets/js/3.c5d2add3.js"><link rel="prefetch" href="/assets/js/30.30bdf688.js"><link rel="prefetch" href="/assets/js/31.04710129.js"><link rel="prefetch" href="/assets/js/32.4b370aaa.js"><link rel="prefetch" href="/assets/js/33.bbf3db92.js"><link rel="prefetch" href="/assets/js/34.2e03dfef.js"><link rel="prefetch" href="/assets/js/35.5b0ed3ea.js"><link rel="prefetch" href="/assets/js/36.0f4c5071.js"><link rel="prefetch" href="/assets/js/37.c4894618.js"><link rel="prefetch" href="/assets/js/38.79d8b940.js"><link rel="prefetch" href="/assets/js/39.9d234465.js"><link rel="prefetch" href="/assets/js/4.a4f75a07.js"><link rel="prefetch" href="/assets/js/40.1e15177a.js"><link rel="prefetch" href="/assets/js/41.fc0bf99c.js"><link rel="prefetch" href="/assets/js/42.455cc8eb.js"><link rel="prefetch" href="/assets/js/43.12175bbc.js"><link rel="prefetch" href="/assets/js/44.c4578c89.js"><link rel="prefetch" href="/assets/js/45.880d4790.js"><link rel="prefetch" href="/assets/js/46.c9ab4cca.js"><link rel="prefetch" href="/assets/js/47.95094b5f.js"><link rel="prefetch" href="/assets/js/48.1d0ff620.js"><link rel="prefetch" href="/assets/js/49.4d98001c.js"><link rel="prefetch" href="/assets/js/5.7962db88.js"><link rel="prefetch" href="/assets/js/50.37d73e08.js"><link rel="prefetch" href="/assets/js/51.33272ffb.js"><link rel="prefetch" href="/assets/js/52.9be0a918.js"><link rel="prefetch" href="/assets/js/53.a14f560a.js"><link rel="prefetch" href="/assets/js/54.b2b0d320.js"><link rel="prefetch" href="/assets/js/55.e87d08c2.js"><link rel="prefetch" href="/assets/js/56.5d81f28c.js"><link rel="prefetch" href="/assets/js/57.c2689ea6.js"><link rel="prefetch" href="/assets/js/58.c249e2be.js"><link rel="prefetch" href="/assets/js/59.e55f70ab.js"><link rel="prefetch" href="/assets/js/6.c81e5570.js"><link rel="prefetch" href="/assets/js/60.189e28a1.js"><link rel="prefetch" href="/assets/js/61.ca950ed0.js"><link rel="prefetch" href="/assets/js/62.bc3cb5ba.js"><link rel="prefetch" href="/assets/js/63.37cb4c4c.js"><link rel="prefetch" href="/assets/js/64.6638e768.js"><link rel="prefetch" href="/assets/js/65.796f150d.js"><link rel="prefetch" href="/assets/js/66.f3cc6d01.js"><link rel="prefetch" href="/assets/js/67.dcfd9386.js"><link rel="prefetch" href="/assets/js/68.ff445130.js"><link rel="prefetch" href="/assets/js/69.c773feae.js"><link rel="prefetch" href="/assets/js/7.731de9d5.js"><link rel="prefetch" href="/assets/js/70.fdd0a0dd.js"><link rel="prefetch" href="/assets/js/71.ac571f19.js"><link rel="prefetch" href="/assets/js/72.327878ec.js"><link rel="prefetch" href="/assets/js/73.72469c48.js"><link rel="prefetch" href="/assets/js/74.bbf9fbef.js"><link rel="prefetch" href="/assets/js/75.2459cfdd.js"><link rel="prefetch" href="/assets/js/76.47f88bba.js"><link rel="prefetch" href="/assets/js/77.672ac7be.js"><link rel="prefetch" href="/assets/js/78.b25fc5d1.js"><link rel="prefetch" href="/assets/js/79.9006f304.js"><link rel="prefetch" href="/assets/js/8.65cff321.js"><link rel="prefetch" href="/assets/js/80.2361aab8.js"><link rel="prefetch" href="/assets/js/81.171f7d51.js"><link rel="prefetch" href="/assets/js/82.c8855203.js"><link rel="prefetch" href="/assets/js/83.13cc8880.js"><link rel="prefetch" href="/assets/js/84.71f4937e.js"><link rel="prefetch" href="/assets/js/85.ec1b5167.js"><link rel="prefetch" href="/assets/js/86.7e9d014a.js"><link rel="prefetch" href="/assets/js/87.0534b172.js"><link rel="prefetch" href="/assets/js/88.449b9fba.js"><link rel="prefetch" href="/assets/js/89.22baba13.js"><link rel="prefetch" href="/assets/js/9.7776c25d.js"><link rel="prefetch" href="/assets/js/90.9275a5a7.js"><link rel="prefetch" href="/assets/js/91.6479bf0a.js"><link rel="prefetch" href="/assets/js/92.ce196deb.js"><link rel="prefetch" href="/assets/js/93.65638b91.js"><link rel="prefetch" href="/assets/js/94.ebcb313d.js"><link rel="prefetch" href="/assets/js/95.2901a323.js"><link rel="prefetch" href="/assets/js/96.4e0dcfcb.js"><link rel="prefetch" href="/assets/js/97.0d5e72af.js"><link rel="prefetch" href="/assets/js/98.3d727174.js"><link rel="prefetch" href="/assets/js/99.3b32ce3f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1404a2ef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="TQK的个人博客" class="logo"> <span class="site-name can-hide">TQK的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="入门基础" class="dropdown-title"><span class="title">入门基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="入门基础" class="mobile-dropdown-title"><span class="title">入门基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/java/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/base/seniorJava/" class="nav-link router-link-active">
  Java基础(高级)
</a></li><li class="dropdown-item"><!----> <a href="/base/data-structure/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/base/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/base/JVM/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/base/es6/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/base/shell/" class="nav-link">
  Shell脚本
</a></li><li class="dropdown-item"><!----> <a href="/base/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/base/c/" class="nav-link">
  C语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/db/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/db/mongdb/" class="nav-link">
  Mongdb
</a></li><li class="dropdown-item"><!----> <a href="/db/oracle/" class="nav-link">
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="/db/db2/" class="nav-link">
  DB2
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/framework/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/framework/springboot/" class="nav-link">
  Springboot
</a></li><li class="dropdown-item"><!----> <a href="/framework/dubbo/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/framework/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringCloud/" class="nav-link">
  SpringCloud-Alibaba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/netty/" class="nav-link">
  netty
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/middleware/gateway/" class="nav-link">
  gateway
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zookeeper/" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zuul/" class="nav-link">
  zuul
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nocas/" class="nav-link">
  nocas
</a></li><li class="dropdown-item"><!----> <a href="/middleware/seata/" class="nav-link">
  seata
</a></li><li class="dropdown-item"><!----> <a href="/middleware/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/middleware/kubernetes/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/middleware/Elasticsearch/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><h4>
          MQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/middleware/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-subitem"><a href="/middleware/ActiveMQ/" class="nav-link">
  ActiveMQ
</a></li><li class="dropdown-subitem"><a href="/middleware/RocketMQ/" class="nav-link">
  RocketMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/alibaba/" class="nav-link">
  阿里巴巴Java开发手册
</a></li><li class="dropdown-item"><!----> <a href="/other/english/" class="nav-link">
  编程英语
</a></li><li class="dropdown-item"><!----> <a href="/other/idea/" class="nav-link">
  IDEA快捷键
</a></li><li class="dropdown-item"><!----> <a href="/other/url/" class="nav-link">
  常用网站
</a></li><li class="dropdown-item"><!----> <a href="/other/jdk/" class="nav-link">
  Liunx安装jdk
</a></li><li class="dropdown-item"><!----> <a href="/other/jiqun/" class="nav-link">
  Liunx集群
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/jemeter/" class="nav-link">
  jemeter
</a></li><li class="dropdown-item"><!----> <a href="/tool/postman/" class="nav-link">
  postman
</a></li><li class="dropdown-item"><!----> <a href="/tool/PowerDesigner/" class="nav-link">
  PowerDesigner
</a></li><li class="dropdown-item"><!----> <a href="/tool/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/tool/Nodejs/" class="nav-link">
  Nodejs
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zeroonbush/blog.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="入门基础" class="dropdown-title"><span class="title">入门基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="入门基础" class="mobile-dropdown-title"><span class="title">入门基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/java/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/base/seniorJava/" class="nav-link router-link-active">
  Java基础(高级)
</a></li><li class="dropdown-item"><!----> <a href="/base/data-structure/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/base/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/base/JVM/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/base/es6/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/base/shell/" class="nav-link">
  Shell脚本
</a></li><li class="dropdown-item"><!----> <a href="/base/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/base/c/" class="nav-link">
  C语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/db/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/db/mongdb/" class="nav-link">
  Mongdb
</a></li><li class="dropdown-item"><!----> <a href="/db/oracle/" class="nav-link">
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="/db/db2/" class="nav-link">
  DB2
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/framework/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/framework/springboot/" class="nav-link">
  Springboot
</a></li><li class="dropdown-item"><!----> <a href="/framework/dubbo/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/framework/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringCloud/" class="nav-link">
  SpringCloud-Alibaba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/netty/" class="nav-link">
  netty
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/middleware/gateway/" class="nav-link">
  gateway
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zookeeper/" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zuul/" class="nav-link">
  zuul
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nocas/" class="nav-link">
  nocas
</a></li><li class="dropdown-item"><!----> <a href="/middleware/seata/" class="nav-link">
  seata
</a></li><li class="dropdown-item"><!----> <a href="/middleware/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/middleware/kubernetes/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/middleware/Elasticsearch/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><h4>
          MQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/middleware/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-subitem"><a href="/middleware/ActiveMQ/" class="nav-link">
  ActiveMQ
</a></li><li class="dropdown-subitem"><a href="/middleware/RocketMQ/" class="nav-link">
  RocketMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/alibaba/" class="nav-link">
  阿里巴巴Java开发手册
</a></li><li class="dropdown-item"><!----> <a href="/other/english/" class="nav-link">
  编程英语
</a></li><li class="dropdown-item"><!----> <a href="/other/idea/" class="nav-link">
  IDEA快捷键
</a></li><li class="dropdown-item"><!----> <a href="/other/url/" class="nav-link">
  常用网站
</a></li><li class="dropdown-item"><!----> <a href="/other/jdk/" class="nav-link">
  Liunx安装jdk
</a></li><li class="dropdown-item"><!----> <a href="/other/jiqun/" class="nav-link">
  Liunx集群
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/jemeter/" class="nav-link">
  jemeter
</a></li><li class="dropdown-item"><!----> <a href="/tool/postman/" class="nav-link">
  postman
</a></li><li class="dropdown-item"><!----> <a href="/tool/PowerDesigner/" class="nav-link">
  PowerDesigner
</a></li><li class="dropdown-item"><!----> <a href="/tool/Jenkins/" class="nav-link">
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/tool/Nodejs/" class="nav-link">
  Nodejs
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zeroonbush/blog.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Senior Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/base/seniorJava/" aria-current="page" class="sidebar-link">JAVA并发编程</a></li><li><a href="/base/seniorJava/Java线程和操作系统线程关系-0.html" class="sidebar-link">1.Java线程和操作系统线程关系</a></li><li><a href="/base/seniorJava/Java线程基础扩充-1.html" class="active sidebar-link">2. Java线程基础扩充</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-jmm内存模型" class="sidebar-link">2.1 JMM内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-1-主内存" class="sidebar-link">2.1.1 主内存</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-2-工作内存" class="sidebar-link">2.1.2 工作内存</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-3-java内存模型与硬件内存架构的关系" class="sidebar-link">2.1.3 Java内存模型与硬件内存架构的关系</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-4-jmm存在的必要性" class="sidebar-link">2.1.4 JMM存在的必要性</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-1-5-并发编程的可见性-原子性与有序性问题" class="sidebar-link">2.1.5 并发编程的可见性，原子性与有序性问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-volatile最轻量的同步机制" class="sidebar-link">2.4 volatile最轻量的同步机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-1-volatile的可见性" class="sidebar-link">2.4.1 volatile的可见性</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-2-volatile无法保证原子性操作" class="sidebar-link">2.4.2 volatile无法保证原子性操作</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-3-volatile禁止重排优化" class="sidebar-link">2.4.3 volatile禁止重排优化</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-4-volatile内存语义的实现" class="sidebar-link">2.4.4 volatile内存语义的实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-内存屏障" class="sidebar-link">2.4 内存屏障</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-1-硬件层的内存屏障" class="sidebar-link">2.4.1 硬件层的内存屏障</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-2-jvm四类内存屏障指令" class="sidebar-link">2.4.2 JVM四类内存屏障指令</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-3-内存屏障" class="sidebar-link">2.4.3 内存屏障</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-4-java内存模型" class="sidebar-link">2.4.4 Java内存模型</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-4-5-指令重排序" class="sidebar-link">2.4.5 指令重排序</a></li></ul></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-java-里的线程" class="sidebar-link">2.3 Java 里的线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-1-start和run方法" class="sidebar-link">2.3.1 start和run方法</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-2-yield-方法" class="sidebar-link">2.3.2 yield()方法</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-3-join-方法" class="sidebar-link">2.3.3 join()方法</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-4-中断方法" class="sidebar-link">2.3.4 中断方法</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-5-终止方法" class="sidebar-link">2.3.5 终止方法</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-6-线程的优先级" class="sidebar-link">2.3.6 线程的优先级</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-7-线程调度" class="sidebar-link">2.3.7 线程调度</a></li><li class="sidebar-sub-header"><a href="/base/seniorJava/Java线程基础扩充-1.html#_2-3-8-守护线程" class="sidebar-link">2.3.8 守护线程</a></li></ul></li></ul></li><li><a href="/base/seniorJava/线程间的共享和协作-2.html" class="sidebar-link">3. 线程间的共享和协作</a></li><li><a href="/base/seniorJava/线程的并发工具类-3.html" class="sidebar-link">4.线程的并发工具类</a></li><li><a href="/base/seniorJava/原子操作 CAS-4.html" class="sidebar-link">5. 原子操作 CAS</a></li><li><a href="/base/seniorJava/显式锁和 AQS-5.html" class="sidebar-link">6. 显式锁和AQS</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2-java线程基础扩充"><a href="#_2-java线程基础扩充" class="header-anchor">#</a> 2. Java线程基础扩充</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_2-1-jmm内存模型">2.1 JMM内存模型</a><ul><li><a href="#_2-1-1-主内存">2.1.1 主内存</a></li><li><a href="#_2-1-2-工作内存">2.1.2 工作内存</a></li><li><a href="#_2-1-3-java内存模型与硬件内存架构的关系">2.1.3 Java内存模型与硬件内存架构的关系</a></li><li><a href="#_2-1-4-jmm存在的必要性">2.1.4 JMM存在的必要性</a></li><li><a href="#_2-1-5-并发编程的可见性-原子性与有序性问题">2.1.5 并发编程的可见性，原子性与有序性问题</a></li></ul></li><li><a href="#_2-4-volatile最轻量的同步机制">2.4 volatile最轻量的同步机制</a><ul><li><a href="#_2-4-1-volatile的可见性">2.4.1 volatile的可见性</a></li><li><a href="#_2-4-2-volatile无法保证原子性操作">2.4.2 volatile无法保证原子性操作</a></li><li><a href="#_2-4-3-volatile禁止重排优化">2.4.3 volatile禁止重排优化</a></li><li><a href="#_2-4-4-volatile内存语义的实现">2.4.4 volatile内存语义的实现</a></li></ul></li><li><a href="#_2-4-内存屏障">2.4 内存屏障</a><ul><li><a href="#_2-4-1-硬件层的内存屏障">2.4.1 硬件层的内存屏障</a></li><li><a href="#_2-4-2-jvm四类内存屏障指令">2.4.2 JVM四类内存屏障指令</a></li><li><a href="#_2-4-3-内存屏障">2.4.3 内存屏障</a></li><li><a href="#_2-4-4-java内存模型">2.4.4 Java内存模型</a></li><li><a href="#_2-4-5-指令重排序">2.4.5 指令重排序</a></li></ul></li><li><a href="#_2-3-java-里的线程">2.3 Java 里的线程</a><ul><li><a href="#_2-3-1-start和run方法">2.3.1 start和run方法</a></li><li><a href="#_2-3-2-yield-方法">2.3.2 yield()方法</a></li><li><a href="#_2-3-3-join-方法">2.3.3 join()方法</a></li><li><a href="#_2-3-4-中断方法">2.3.4 中断方法</a></li><li><a href="#_2-3-5-终止方法">2.3.5 终止方法</a></li><li><a href="#_2-3-6-线程的优先级">2.3.6 线程的优先级</a></li><li><a href="#_2-3-7-线程调度">2.3.7 线程调度</a></li><li><a href="#_2-3-8-守护线程">2.3.8 守护线程</a></li></ul></li></ul></div><p></p> <h2 id="_2-1-jmm内存模型"><a href="#_2-1-jmm内存模型" class="header-anchor">#</a> 2.1 JMM内存模型</h2> <p>JMM与JVM内存区域的划分是不同的概念层次，更恰当说JMM描述的是一组规则，通过这组规则控制程序中各个变量在共享数据区域和私有数据区域的访问方式，<strong>JMM是围绕 原子性，有序性、可见性展开</strong>。
<a data-fancybox="" title="JMM内存模型" href="./image/JMM02.jpg"><img src="/assets/img/JMM02.42d6c756.jpg" alt="JMM内存模型"></a></p> <p>JMM与Java内存区域唯一相似点，都存在共享数据区域和 私有数据区域，在JMM中主内存属于共享数据区域，从某个程度上讲应该包括了堆和方法区，而工作内存数据线程私有数据区域，从某个程度上讲则应该包括程序计数器、虚拟机栈 以及本地方法栈。 线程，工作内存，主内存工作交互图（基于JMM规范）</p> <h3 id="_2-1-1-主内存"><a href="#_2-1-1-主内存" class="header-anchor">#</a> 2.1.1 主内存</h3> <p>主要存储的是Java实例对象，所有线程创建的实例对象都存放在主内存中，<strong>不管该实例对象是成员变量还是方法中的本地变量(也称局部变量)</strong>，当然也包括了共享的类信息、常量、静态变量。由于是共享数据区域，多条线程对同一个变量进行访问可能会发生线程安全问题。</p> <h3 id="_2-1-2-工作内存"><a href="#_2-1-2-工作内存" class="header-anchor">#</a> 2.1.2 工作内存</h3> <p>主要存储当前方法的所有本地变量信息(工作内存中存储着主内存中的变量副本拷贝)， 每个线程只能访问自己的工作内存，即线程中的本地变量对其它线程是不可见的，就算是两个线程执行的是同一段代码，它们也会各自在自己的工作内存中创建属于当前线程的本地变量，当然也包括了字节码行号指示器、相关Native方法的信息。</p> <p>注意由于工作内存是每个线程的私有数据，线程间无法相互访问工作内存，因此存储在工作内存的数据不存在线程安全问题。</p> <p><a data-fancybox="" title="JMM内存模型" href="./image/JMM03.jpg"><img src="/assets/img/JMM03.e2f86e77.jpg" alt="JMM内存模型"></a></p> <p>根据JVM虚拟机规范主内存与工作内存的数据存储类型以及操作方式，对于一个实例对 象中的成员方法而言，如果方法中包含本地变量是基本数据类型 （boolean,byte,short,char,int,long,float,double），将直接存储在工作内存的帧栈结构 中，但倘若本地变量是引用类型，那么该变量的引用会存储在功能内存的帧栈中，而<strong>对象实例将存储在主内存(共享数据区域，堆)中</strong>。但对于实例对象的成员变量，不管它是基本数据 类型或者包装类型(Integer、Double等)还是引用类型，都会被存储到堆区。至于static变 量以及类本身相关信息将会存储在主内存中。需要注意的是，在主内存中的实例对象可以被多线程共享，倘若两个线程同时调用了同一个对象的同一个方法，那么两条线程会将要操作的数据拷贝一份到自己的工作内存中，执行完成操作后才刷新到主内存</p> <h3 id="_2-1-3-java内存模型与硬件内存架构的关系"><a href="#_2-1-3-java内存模型与硬件内存架构的关系" class="header-anchor">#</a> 2.1.3 Java内存模型与硬件内存架构的关系</h3> <p>通过对前面的硬件内存架构、Java内存模型以及Java多线程的实现原理的了解，我们应该已经意识到，多线程的执行最终都会映射到硬件处理器上进行执行，但Java内存模型和硬件内存架构并不完全一致。</p> <p>对于硬件内存来说只有<strong>寄存器、缓存内存、主内存</strong>的概念，并没有工作内存(线程私有数据区域)和主内存(堆内存)之分，也就是说Java内存模型对内存的划分对硬件内存并没有任何影响.
因为JMM只是一种抽象的概念，是一组规则，并不实际存在，不管是工作内存的数据还是主内存的数据，对于计算机硬件来说都会存储在计算机主内存中，当然也有可能存储到CPU缓存或者寄存器中，因此总体上来说，Java内存模型和计算 机硬件内存架构是一个相互交叉的关系，是一种抽象概念划分与真实物理硬件的交叉。(注意对于Java内存区域划分也是同样的道理)</p> <p><a data-fancybox="" title="JMM内存模型" href="./image/JMM04.jpg"><img src="/assets/img/JMM04.f3a1339e.jpg" alt="JMM内存模型"></a></p> <h3 id="_2-1-4-jmm存在的必要性"><a href="#_2-1-4-jmm存在的必要性" class="header-anchor">#</a> 2.1.4 JMM存在的必要性</h3> <p>在明白了Java内存区域划分、硬件内存架构、Java多线程的实现原理与Java内存模型 的具体关系后，接着来谈谈Java内存模型存在的必要性。由于JVM运行程序的实体是线程，而每个线程创建时JVM都会为其创建一个工作内存(有些地方称为栈空间)，用于存储线程私有的数据，线程与主内存中的变量操作必须通过工作内存间接完成，主要过程是将变量从主内存拷贝的每个线程各自的工作内存空间，然后对变量进行操作，操作完成后再将变量写回主内存，如果存在两个线程同时对一个主内存中的实例对象的变量进行操作就有可能诱发线程安全问题。</p> <p>假设主内存中存在一个共享变量x，现在有A和B两条线程分别对该变量x=1进行操作， A/B线程各自的工作内存中存在共享变量副本x。</p> <ol><li><p>假设现在A线程想要修改x的值为2，而B线程却想要读取x的值，那么B线程读取到的值是A线程更新后的值2还是更新前的值1呢？</p></li> <li><p>答案 不确定，即B线程有可能读取到A线程更新前的值1，也有可能读取到A线程更新后的值 2，</p></li> <li><p>这是因为工作内存是每个线程私有的数据区域，而线程A变量x时，首先是将变量从主内存拷贝到A线程的工作内存中，然后对变量进行操作，操作完成后再将变量x写回主内存，</p></li> <li><p>而对于B线程的也是类似的，这样就有可能造成主内存与工作内存间数据存在一致性问题，假如A线程修改完后正在将数据写回主内存，</p></li> <li><p>而B线程此时正在读取主内存，即将x=1拷贝到自己的工作内存中，这样B线程读取到的值就是x=1，但如果A线程已将x=2写回主内存后， B线程才开始读取的话，那么此时B线程读取到的就是x=2，但到底是哪种情况先发生呢？
如以下示例图所示：</p></li></ol> <p><a data-fancybox="" title="JMM存在的必要性" href="./image/JMM05.jpg"><img src="/assets/img/JMM05.bcaf554b.jpg" alt="JMM存在的必要性"></a>
以上关于主内存与工作内存之间的具体交互协议，即一个变量如何从主内存拷贝到工作 内存、如何从工作内存同步到主内存之间的实现细节，Java内存模型定义了以下八种操作来完成。</p> <div class="custom-block tip"><p class="custom-block-title">数据同步八大原子操作</p> <p>（1）<font color="red"><strong>lock(锁定)</strong></font>：作用于主内存的变量，把一个变量标记为一条线程独占状态</p> <p>（2）<font color="red"><strong>unlock(解锁)</strong></font>：作用于主内存的变量，把一个处于锁定状态的变量释放出来，释放后 的变量才可以被其他线程锁定</p> <p>（3）<font color="red"><strong>read(读取)</strong></font>：作用于主内存的变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</p> <p>（4）<font color="red"><strong>load(载入)</strong></font>：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中</p> <p>（5）<font color="red"><strong>use(使用)</strong></font>：作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎</p> <p>（6）<font color="red"><strong>assign(赋值)</strong></font>：作用于工作内存的变量，它把一个从执行引擎接收到的值赋给工作内存的变量</p> <p>（7）<font color="red"><strong>store(存储)</strong></font>：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作</p> <p>（8）<font color="red"><strong>write(写入)</strong></font>：作用于工作内存的变量，它把store操作从工作内存中的一个变量的值传送到主内存的变量中</p> <p>如果要把一个变量从主内存中复制到工作内存中，就需要按顺序地执行read和load操作，如果把变量从工作内存中同步到主内存中，就需要按顺序地执行store和write操作。但Java内存模型只要求上述操作必须按顺序执行，而没有保证必须是连续执行。</p></div> <p><a data-fancybox="" title="数据同步八大原子操作" href="./image/JMM06.jpg"><img src="/assets/img/JMM06.b31829e8.jpg" alt="数据同步八大原子操作"></a></p> <div class="custom-block tip"><p class="custom-block-title">同步规则分析</p> <ol><li>不允许一个线程无原因地（没有发生过任何assign操作）把数据从工作内存同步回主内存中</li> <li>一个新的变量只能在主内存中诞生，不允许在工作内存中直接使用一个未被初始化 （load或者assign）的变量。即就是对一个变量实施use和store操作之前，必须先自行 assign和load操作。</li> <li>一个变量在同一时刻只允许一条线程对其进行lock操作，但lock操作可以被同一线程重 复执行多次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。lock 和unlock必须成对出现。</li> <li>如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个 变量之前需要重新执行load或assign操作初始化变量的值。</li> <li>如果一个变量事先没有被lock操作锁定，则不允许对它执行unlock操作；也不允许去 unlock一个被其他线程锁定的变量。</li> <li>对一个变量执行unlock操作之前，必须先把此变量同步到主内存中（执行store和write 操作）</li></ol></div> <h3 id="_2-1-5-并发编程的可见性-原子性与有序性问题"><a href="#_2-1-5-并发编程的可见性-原子性与有序性问题" class="header-anchor">#</a> 2.1.5 并发编程的可见性，原子性与有序性问题</h3> <div class="custom-block tip"><p class="custom-block-title">并发编程三大原则</p> <ol><li>原子性</li> <li>有序性</li> <li>可见性</li></ol></div> <h4 id="_2-1-5-1-原子性"><a href="#_2-1-5-1-原子性" class="header-anchor">#</a> 2.1.5.1 原子性</h4> <p>原子性指的是一个操作是不可中断的，即使是在多线程环境下，一个操作一旦开始就不会被其他线程影响。</p> <p>在java中，对基本数据类型的变量的读取和赋值操作是原子性操作有点要注意的是，对于32位系统的来说，long类型数据和double类型数据(对于基本数据类型，
byte,short,int,float,boolean,char读写是原子操作)，它们的读写并非原子性的，也就是说如果存在两条线程同时对long类型或者double类型的数据进行读写是存在相互干扰的，因为对于32位虚拟机来说，每次原子读写是32位的，而long和double则是64位的存储单元， 这样会导致一个线程在写时，操作完前32位的原子操作后，轮到B线程读取时，恰好只读取到了后32位的数据，这样可能会读取到一个既非原值又不是线程修改值的变量，它可能是“半个变量”的数值，即64位数据被两个线程分成了两次读取。但也不必太担心，因为读取到“半个变量”的情况比较少见，至少在目前的商用的虚拟机中，几乎都把64位的数 据的读写操作作为原子操作来执行，因此对于这个问题不必太在意，知道这么回事即可。</p> <h4 id="原子性问题"><a href="#原子性问题" class="header-anchor">#</a> 原子性问题</h4> <p>除了JVM自身提供的对基本数据类型读写操作的原子性外，<font color="red"><strong>可以通过 synchronized和 Lock实现原子性</strong></font>。因为synchronized和Lock能够保证任一时刻只有一个线程访问该代码块。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>tl01<span class="token punctuation">.</span>cpu</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description: 原子性
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jmm04_CodeAtomic</span> <span class="token punctuation">{</span>
    <span class="token comment">//volatile关键字无法保证 原子性</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//                    counter++;//分三步- 读，自加，写回</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        counter<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//分三步- 读，自加，写回</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">X</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//原子性（简单的读取、将数字赋值给变量） </span>
<span class="token class-name">Y</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">//变量之间的相互赋值，不是原子操作 </span>
<span class="token class-name">X</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//对变量进行计算操作 </span>
<span class="token class-name">X</span> <span class="token operator">=</span> x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_2-1-5-2-可见性"><a href="#_2-1-5-2-可见性" class="header-anchor">#</a> 2.1.5.2 可见性</h4> <p>理解了指令重排现象后，可见性容易了，可见性指的是当一个线程修改了某个共享变量 的值，其他线程是否能够马上得知这个修改的值。对于串行程序来说，可见性是不存在的， 因为我们在任何一个操作中修改了某个变量的值，后续的操作中都能读取这个变量值，并且是修改过的新值。 但在多线程环境中可就不一定了，前面我们分析过，由于线程对共享变量的操作都是线 程拷贝到各自的工作内存进行操作后才写回到主内存中的，这就可能存在一个线程A修改了共享变量x的值，还未写回主内存时，另外一个线程B又对主内存中同一个共享变量x进行操作，但此时A线程工作内存中共享变量x对线程B来说并不可见，这种工作内存与主内存同步 延迟现象就造成了可见性问题，另外指令重排以及编译器优化也可能导致可见性问题，通过 前面的分析，我们知道无论是编译器优化还是处理器优化的重排现象，在多线程环境下，确实会导致程序轮序执行的问题，从而也就导致可见性问题。</p> <h4 id="可见性问题"><a href="#可见性问题" class="header-anchor">#</a> 可见性问题</h4> <p>volatile关键字保证可见性。当一个共享变量被volatile修饰时，它会保证修改的值立即被其他的线程看到，即修改的值立即更新到主存中，当其他线程需要读取时，它会去内存中读取新值。synchronized和Lock也可以保证可见性，因为它们可以保证任一时刻只有一个线程能访问共享资源，并在其释放锁之前将修改的变量刷新到内存中。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>tl01<span class="token punctuation">.</span>cpu</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @author tianqikai
 *  volatile 可见性
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jmm03_CodeVisibility</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> initFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//    private static boolean initFlag = false;</span>
    
    <span class="token comment">//对counter也是可以的；因为volatile防止了指令重排</span>
<span class="token comment">//    private volatile static int counter = 0;</span>
    <span class="token keyword">private</span>  <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;refresh data.......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;refresh data success.......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> threadA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>initFlag<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//System.out.println(&quot;runing&quot;);</span>
                counter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;当前线程嗅探到initFlag的状态的改变   &quot;</span><span class="token operator">+</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;threadA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Thread</span> threadB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;threadB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h4 id="_2-1-5-3-有序性"><a href="#_2-1-5-3-有序性" class="header-anchor">#</a> 2.1.5.3 有序性</h4> <p>有序性是指对于单线程的执行代码，我们总是认为代码的执行是按顺序依次执行的，这样的理解并没有毛病，毕竟对于单线程而言确实如此，但对于多线程环境，则可能出现乱序现象，因为程序编译成机器码指令后可能会出现<strong>指令重排现象</strong>，重排后的指令与原指令的顺序未必一致，要明白的是，在Java程序中，倘若在本线程内，所有操作都视为有序行为，如果是多线程环境下，一个线程中观察另外一个线程，所有操作都是无序的，前半句指的是单线程内保证串行语义执行的一致性，后半句则指指令重排现象和工作内存与主内存同步延迟现象。</p> <h4 id="有序性问题"><a href="#有序性问题" class="header-anchor">#</a> 有序性问题</h4> <p>在Java里面，可以通过volatile关键字来保证一定的“有序性”（具体原理在下一节讲 述volatile关键字）。另外可以通过synchronized和Lock来保证有序性，很显然， synchronized和Lock保证每个时刻是有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然就保证了有序性。</p> <p>int x = 0, y = 0;
int a = 0, b = 0;</p> <div class="custom-block tip"><p class="custom-block-title">以下案例高并发可能出现四种结果</p> <ol><li><p>线程A先执行 a=1 x=b; 线程B后执行 b=1 y=a                      返回结果： x=0 y=1;</p></li> <li><p>线程A先执行 a=1 ;线程B后执行 b=1;         线程A执行 x=b; 线程B执行 y=a; 返回结果： x=1 y=1;</p></li> <li><p>线程A先执行 a=1 ;线程B后执行 b=1 y=a;    线程A执行 x=b;          返回结果： x=1 y=1;</p></li> <li><p>线程B先执行 b=1 y=a;线程A后执行 a=1 x=b;         线程A执行 x=b; 线程B执行 y=a; 返回结果： x=1 y=0;</p></li> <li><p>线程B先执行 b=1 ;线程A后执行 a=1 x=b; 线程B执行 y=a;    返回结果： x=1 y=1;</p></li> <li><p>线程B先执行 b=1 ;线程A后执行 a=1; 线程B执行 y=a; 线程A执行 x=b;    返回结果： x=1 y=1;</p></li> <li><p>发生指令重排
线程A先执行 x=b； 线程B后执行 y=a  b=1   线程A再执行 a=1 ;                 返回结果： x=0 y=0;</p></li></ol></div> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>tl01<span class="token punctuation">.</span>cpu</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @author ：
 * @description:  volatile保证有序性
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jmm05_CodeReorder</span> <span class="token punctuation">{</span>
<span class="token comment">//    private volatile static int x = 0, y = 0;</span>
<span class="token comment">//    private volatile static int a = 0, b = 0;</span>
	<span class="token comment">//不加volatile关键字会发生指令重排</span>
    <span class="token keyword">private</span>  <span class="token keyword">static</span> <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token keyword">static</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">shortWait</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    x <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token comment">//                    UnsafeInstance.reflectGetUnsafe().fullFence();</span>
                    <span class="token comment">///</span>
                    <span class="token comment">//</span>
                    <span class="token comment">//</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//                    UnsafeInstance.reflectGetUnsafe().fullFence();</span>
                    y <span class="token operator">=</span> a<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;次 (&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">&quot;）&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 等待一段时间，时间单位纳秒
     * @param interval
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shortWait</span><span class="token punctuation">(</span><span class="token keyword">long</span> interval<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end<span class="token punctuation">;</span>
        <span class="token keyword">do</span><span class="token punctuation">{</span>
            end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>start <span class="token operator">+</span> interval <span class="token operator">&gt;=</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>第19825次 <span class="token punctuation">(</span><span class="token number">0,1</span>）
第19826次 <span class="token punctuation">(</span><span class="token number">0,1</span>）
第19827次 <span class="token punctuation">(</span><span class="token number">0,1</span>）
第19828次 <span class="token punctuation">(</span><span class="token number">0,1</span>）
第19829次 <span class="token punctuation">(</span><span class="token number">0,1</span>）
第19830次 <span class="token punctuation">(</span><span class="token number">0,0</span>）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-4-volatile最轻量的同步机制"><a href="#_2-4-volatile最轻量的同步机制" class="header-anchor">#</a> 2.4 volatile最轻量的同步机制</h2> <div class="custom-block tip"><p class="custom-block-title">volatile关键字作用</p> <ol><li><p>保证被volatile修饰的共享变量对所有线程总数可见的，也就是当一个线程修改了一个被volatile修饰共享变量的值，新值总是可以被其他线程立即得知。</p></li> <li><p>禁止指令重排序优化</p></li> <li><p>无法保证原子性操作</p></li></ol></div> <p>volatile 解决多线程内存不可见问题。对于一写多读，是可以解决变量同步问题</p> <p>但是如果多写，同样无法解决线程安全问题。如果是count++ 操作，使用如下类实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> count<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果是JDK8，推荐使用 LongAdder 对象，比 AtomicLong 性能更好（减少乐观锁的重试次数）。</p> <h3 id="_2-4-1-volatile的可见性"><a href="#_2-4-1-volatile的可见性" class="header-anchor">#</a> 2.4.1 volatile的可见性</h3> <p><strong>不加volatile时，子线程无法感知主线程修改了ready的值，从而不会退出循环， 而加了volatile 后，子线程可以感知主线程修改了ready的值，迅速退出循环</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 类说明：演示Volatile的提供的可见性
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileCase</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span>  <span class="token keyword">volatile</span>  <span class="token keyword">static</span> <span class="token keyword">boolean</span> ready<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> number<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PrintThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;PrintThread is running.......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number = &quot;</span><span class="token operator">+</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;子线程感知到了ready值的变化！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">PrintThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SleepTools</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        number <span class="token operator">=</span> <span class="token number">51</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">SleepTools</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main is ended!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_2-4-2-volatile无法保证原子性操作"><a href="#_2-4-2-volatile无法保证原子性操作" class="header-anchor">#</a> 2.4.2 volatile无法保证原子性操作</h3> <p><strong>但是volatile不能保证数据在多个线程下同时写时的线程安全</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotSafe</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> count <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token keyword">long</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//count进行累加</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">incCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//线程</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">NotSafe</span> simplOper<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token class-name">NotSafe</span> simplOper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>simplOper <span class="token operator">=</span> simplOper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                simplOper<span class="token punctuation">.</span><span class="token function">incCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">NotSafe</span> simplOper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动两个线程</span>
        <span class="token class-name">Count</span> count1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span>simplOper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Count</span> count2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span>simplOper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        count1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        count2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simplOper<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>在并发场景下，count变量的任何改变都会立马反应到其他线程中，但是如此存在多条线程 同时调用incCount()方法的话，就会出现线程安全问题，</p> <p>毕竟count++;操作并不具备原子性，该操作是先读取值，然后写回一个新值，相当于原来的值加上1，分两步完成；</p> <p>如果第二个线程在第一个线程读取旧值和写回新值期间读取i的域值，那么第二个线程就会与第一个线程一起看到同一个值，并执行相同值的加1操作，这也就造成了线程安全失败，因此对于 incCount方法必须使用synchronized修饰，以便保证线程安全，需要注意的是一旦使用 synchronized修饰方法后，</p> <p>由于synchronized本身也具备与volatile相同的特性<strong>即可见性</strong>，因此在这样种情况下就完全可以省去volatile修饰变量。</p> <h3 id="_2-4-3-volatile禁止重排优化"><a href="#_2-4-3-volatile禁止重排优化" class="header-anchor">#</a> 2.4.3 volatile禁止重排优化</h3> <p>volatile关键字另一个作用就是禁止指令重排优化，从而避免多线程环境下程序出现乱序执行的现象，关于指令重排优化前面已详细分析过，这里主要简单说明一下volatile是如何实现禁止指令重排优化的。先了解一个概念，内存屏障(Memory Barrier）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>tl01<span class="token punctuation">.</span>cpu</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DoubleCheckLock</span> <span class="token punctuation">{</span>
    <span class="token comment">//禁止指令重排优化</span>
<span class="token comment">//    private volatile  static DoubleCheckLock instance;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DoubleCheckLock</span> instance<span class="token punctuation">;</span> 
     <span class="token keyword">private</span> <span class="token class-name">DoubleCheckLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DoubleCheckLock</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//第一次检测</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token comment">//同步</span>
             <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">DoubleCheckLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                     <span class="token comment">//多线程环境下可能会出现问题的地方</span>
                     instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoubleCheckLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上述代码一个经典的单例的双重检测的代码，这段代码在单线程环境下并没有什么问 题，但如果在多线程环境下就可以出现线程安全问题。原因在于某一个线程执行到第一次检 测，读取到的instance不为null时，instance的引用对象可能没有完成初始化。</p> <p>因为instance = new DoubleCheckLock();不是原子性操作；可以分为以下3步完成(伪代码)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//1.分配对象内存空间 </span>
memory <span class="token operator">=</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2.初始化对象</span>
<span class="token function">instance</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3.设置instance指向刚分配的内存地址，此时instanc e！=null</span>
instance <span class="token operator">=</span> memory<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由于步骤2和步骤3不存在数据依赖关系，而且无论重排前还是重排后程序的执行结果 在单线程中并没有改变，因此这种重排优化是允许的。</p> <p>但是指令重排只会保证串行语义的执行的一致性(单线程)，</p> <p>但并不会关心多线程间的语义一致性。所以当一条线程访问instance 不为null时，由于instance实例未必已初始化完成，也就造成了线程安全问题。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1</span> memory<span class="token operator">=</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1.分配对象内存空间 </span>
<span class="token number">2</span> instance<span class="token operator">=</span>memory<span class="token punctuation">;</span><span class="token comment">//3.设置instance指向刚分配的内存地址，此时instanc e！=null，但是对象还没有初始化完成！ </span>
<span class="token number">3</span> <span class="token function">instance</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2.初始化对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么该如何解决呢？很简单，我们使用volatile禁止instance变量被执行指令重排优化即可。</p> <h3 id="_2-4-4-volatile内存语义的实现"><a href="#_2-4-4-volatile内存语义的实现" class="header-anchor">#</a> 2.4.4 volatile内存语义的实现</h3> <p>前面提到过重排序分为编译器重排序和处理器重排序。为了实现volatile内存语义， JMM会分别限制这两种类型的重排序类型。 下图是JMM针对编译器制定的volatile重排序规则表。</p> <table width="900" cellspacing="0"><tr><th>第一个操作</th> <th>第二个操作：普通读写</th> <th>第二个操作：volatile读</th> <th>第二个操作：volatile写</th></tr> <tr><td>普通读写  </td> <td>可以重排 </td> <td>可以重排 </td> <td>不可以重排</td></tr> <tr><td>volatile读 </td> <td>不可以重排 </td> <td>不可以重排 </td> <td>不可以重排 </td></tr> <tr><td>volatile写 </td> <td>可以重排 </td> <td>不可以重排 </td> <td>不可以重排</td></tr></table> <div class="custom-block tip"><p class="custom-block-title">从上图可以看出</p> <div class="language- extra-class"><pre><code>当第二个操作是volatile写时，不管第一个操作是什么，都不能重排序。这个规则确保volatile写之前的操作不会被编译器重排序到volatile写之后。 
当第一个操作是volatile读时，不管第二个操作是什么，都不能重排序。这个规则确保volatile读之后的操作不会被编译器重排序到volatile读之前。 
当第一个操作是volatile写，第二个操作是volatile读时，不能重排序。
</code></pre></div></div> <p>为了实现volatile的内存语义，编译器在生成字节码时，会在指令序列中插入内存屏障 来禁止特定类型的处理器重排序。对于编译器来说，发现一个最优布置来最小化插入屏障的 总数几乎不可能。为此，JMM采取保守策略。</p> <div class="custom-block tip"><p class="custom-block-title">基于保守策略的JMM内存屏障插入策略</p> <ol><li>在每个volatile写操作的前面插入一个StoreStore屏障。</li> <li>在每个volatile写操作的后面插入一个StoreLoad屏障。</li> <li>在每个volatile读操作的后面插入一个LoadLoad屏障。</li> <li>在每个volatile读操作的后面插入一个LoadStore屏障。</li></ol></div> <p>上述内存屏障插入策略非常保守，但它可以保证在任意处理器平台，任意的程序中都能得到正确的volatile内存语义。</p> <h2 id="_2-4-内存屏障"><a href="#_2-4-内存屏障" class="header-anchor">#</a> 2.4 内存屏障</h2> <h3 id="_2-4-1-硬件层的内存屏障"><a href="#_2-4-1-硬件层的内存屏障" class="header-anchor">#</a> 2.4.1 硬件层的内存屏障</h3> <p>Intel硬件提供了一系列的内存屏障，主要有：</p> <ol><li>lfence，是一种Load Barrier 读屏障</li> <li>sfence, 是一种Store Barrier 写屏障</li> <li>mfence, 是一种全能型的屏障，具备ifence和sfence的能力</li> <li>Lock前缀，Lock不是一种内存屏障，但是它能完成类似内存屏障的功能。Lock会对 CPU总线和高速缓存加锁，可以理解为CPU指令级的一种锁。它后面可以跟ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, and XCHG等指令。</li></ol> <h3 id="_2-4-2-jvm四类内存屏障指令"><a href="#_2-4-2-jvm四类内存屏障指令" class="header-anchor">#</a> 2.4.2 JVM四类内存屏障指令</h3> <p>不同硬件实现内存屏障的方式不同，Java内存模型屏蔽了这种底层硬件平台的差异，由 JVM来为不同的平台生成相应的机器码。</p> <div class="custom-block tip"><p class="custom-block-title">JVM中提供了四类内存屏障指令</p> <table width="900" cellspacing="0"><tr><th>屏障类型 </th> <th>指令示例 </th> <th>说明 </th></tr> <tr><td>LoadLoad </td> <td>Load1; LoadLoad; Load2 </td> <td>保证load1的读取操作在load2及后续读取操作之前执行 </td></tr> <tr><td>StoreStore  </td> <td>Store1; StoreStore; Store2</td> <td>在store2及其后的写操作执行前，保证store1的写操作已刷新到主内存 </td></tr> <tr><td>LoadStore  </td> <td>Load1; LoadStore; Store2  </td> <td>在stroe2及其后的写操作执行前，保证load1的读操作已读取结束  </td></tr> <tr><td>StoreLoad  </td> <td>Store1; StoreLoad; Load2 </td> <td>保证store1的写操作已刷新到主内存之后，load2及其后的读操作才能执行 </td></tr></table></div> <h5 id="下面是保守策略下-volatile写插入内存屏障后生成的指令序列示意图"><a href="#下面是保守策略下-volatile写插入内存屏障后生成的指令序列示意图" class="header-anchor">#</a> 下面是保守策略下，volatile写插入内存屏障后生成的指令序列示意图</h5> <p><a data-fancybox="" title="保守策略内存屏障" href="./image/volatile01.jpg"><img src="/assets/img/volatile01.88100863.jpg" alt="保守策略内存屏障"></a>
上图中StoreStore屏障可以保证在volatile写之前，其前面的所有普通写操作已经对任 意处理器可见了。这是因为StoreStore屏障将保障上面所有的普通写在volatile写之前刷新到主内存。</p> <h5 id="下图是在保守策略下-volatile读插入内存屏障后生成的指令序列示意图"><a href="#下图是在保守策略下-volatile读插入内存屏障后生成的指令序列示意图" class="header-anchor">#</a> 下图是在保守策略下，volatile读插入内存屏障后生成的指令序列示意图</h5> <p>上图中LoadLoad屏障用来禁止处理器把上面的volatile读与下面的普通读重排序。 LoadStore屏障用来禁止处理器把上面的volatile读与下面的普通写重排序。
<a data-fancybox="" title="保守策略内存屏障" href="./image/volatile02.jpg"><img src="/assets/img/volatile02.85f1906a.jpg" alt="保守策略内存屏障"></a></p> <p>这里比较有意思的是，volatile写后面的StoreLoad屏障。此屏障的作用是避免volatile 写与 后面可能有的volatile读/写操作重排序。因为编译器常常无法准确判断在一个volatile 写的后面 是否需要插入一个StoreLoad屏障（比如，一个volatile写之后方法立即 return）。</p> <p>为了保证能正确实现volatile的内存语义，JMM在采取了保守策略：在每个volatile写的后面，或者在每个volatile 读的前面插入一个StoreLoad屏障。从整体执行效 率的角度考虑，JMM最终选择了在每个 volatile写的后面插入一个StoreLoad屏障。因为 volatile写-读内存语义的常见使用模式是：一个 写线程写volatile变量，多个读线程读同一 个volatile变量。当读线程的数量大大超过写线程时，选择在volatile写之后插入StoreLoad 屏障将带来可观的执行效率的提升。从这里可以看到JMM 在实现上的一个特点：首先确保 正确性，然后再去追求执行效率</p> <hr> <p>上述volatile写和volatile读的内存屏障插入策略非常保守。在实际执行时，只要不改变 volatile写-读的内存语义，编译器可以根据具体情况省略不必要的屏障。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">VolatileBarrierExample</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> a<span class="token punctuation">;</span>
       <span class="token keyword">volatile</span> <span class="token keyword">int</span> v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">volatile</span> <span class="token keyword">int</span> v2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
       <span class="token keyword">void</span> <span class="token function">readAndWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">int</span> i <span class="token operator">=</span> v1<span class="token punctuation">;</span>　　    <span class="token comment">// 第一个volatile读</span>
           <span class="token keyword">int</span> j <span class="token operator">=</span> v2<span class="token punctuation">;</span>    　  <span class="token comment">// 第二个volatile读</span>
           a <span class="token operator">=</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>         <span class="token comment">// 普通写</span>
           v1 <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     　 <span class="token comment">// 第一个volatile写</span>
          v2 <span class="token operator">=</span> j <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>    　  <span class="token comment">// 第二个 volatile写</span>
       <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="针对readandwrite-方法-编译器在生成字节码时可以做如下的优化。"><a href="#针对readandwrite-方法-编译器在生成字节码时可以做如下的优化。" class="header-anchor">#</a> 针对readAndWrite()方法，编译器在生成字节码时可以做如下的优化。</h4> <p><a data-fancybox="" title="保守策略内存屏障" href="./image/volatile03.jpg"><img src="/assets/img/volatile03.f0bd882d.jpg" alt="保守策略内存屏障"></a></p> <p>注意，最后的StoreLoad屏障不能省略。因为第二个volatile写之后，方法立即 return。此时编 译器可能无法准确断定后面是否会有volatile读或写，为了安全起见，编译 器通常会在这里插 入一个StoreLoad屏障。 上面的优化针对任意处理器平台，由于不同的处理器有不同“松紧度”的处理器内存模 型，内存屏障的插入还可以根据具体的处理器内存模型继续优化。以X86处理器为例，图3- 21 中除最后的StoreLoad屏障外，其他的屏障都会被省略。 前面保守策略下的volatile读和写，在X86处理器平台可以优化成如下图所示。前文提 到过，X86处理器仅会对写-读操作做重排序。X86不会对读-读、读-写和写-写操作 做重排序，因此在X86处理器中会省略掉这3种操作类型对应的内存屏障。在X86中，JMM仅需 在 volatile写后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义。这意味着
在 X86处理器中，volatile写的开销比volatile读的开销会大很多（因为执行StoreLoad屏障 开销会比 较大）</p> <p><a data-fancybox="" title="保守策略内存屏障" href="./image/volatile04.jpg"><img src="/assets/img/volatile04.91ccccb9.jpg" alt="保守策略内存屏障"></a></p> <h3 id="_2-4-3-内存屏障"><a href="#_2-4-3-内存屏障" class="header-anchor">#</a> 2.4.3 内存屏障</h3> <p>又称内存栅栏，是一个CPU指令，它的作用有两个，一是保证特定操作的执 行顺序，二是保证某些变量的内存可见性（利用该特性实现volatile的内存可见性）。由于 编译器和处理器都能执行指令重排优化。如果在指令间插入一条Memory Barrier则会告诉 编译器和CPU，不管什么指令都不能和这条Memory Barrier指令重排序，也就是说通过插 入内存屏障禁止在内存屏障前后的指令执行重排序优化。Memory Barrier的另外一个作用 是强制刷出各种CPU的缓存数据，因此任何CPU上的线程都能读取到这些数据的最新版本。 总之，volatile变量正是通过内存屏障实现其在内存中的语义，即可见性和禁止重排优化。</p> <h3 id="_2-4-4-java内存模型"><a href="#_2-4-4-java内存模型" class="header-anchor">#</a> 2.4.4 Java内存模型</h3> <p>每个线程都有自己的工作内存（类似于前面的高速缓存）。线程对变 量的所有操作都必须在工作内存中进行，而不能直接对主存进行操作。并且每个线程不能访 问其他线程的工作内存。Java内存模型具备一些先天的“有序性”，即不需要通过任何手段 就能够得到保证的有序性，这个通常也称为happens-before 原则。如果两个操作的执行次 序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以 随意地对它们进行重排序。</p> <h3 id="_2-4-5-指令重排序"><a href="#_2-4-5-指令重排序" class="header-anchor">#</a> 2.4.5 指令重排序</h3> <p>java语言规范规定JVM线程内部维持顺序化语义。即只要程序的最终结果与它顺序化情况的结果相等，那么指令的执行顺序可以与代码顺序不一致，此过程叫指令的重排序。指令重排序的意义是什么？JVM能根据处理器特性（CPU多级缓存系统、多核处 理器等）适当的对机器指令进行重排序，使机器指令能更符合CPU的执行特性，最大限度的发挥机器性能。</p> <p>下图为从源码到最终执行的指令序列示意图：
<a data-fancybox="" title="指令重排序" href="./image/JMM07.jpg"><img src="/assets/img/JMM07.6bb87488.jpg" alt="指令重排序"></a></p> <h4 id="as-if-serial语义"><a href="#as-if-serial语义" class="header-anchor">#</a> as-if-serial语义</h4> <p>as-if-serial语义的意思是：不管怎么重排序（编译器和处理器为了提高并行度），（单 线程）程序的执行结果不能被改变。编译器、runtime和处理器都必须遵守as-if-serial语义。</p> <p>为了遵守as-if-serial语义，编译器和处理器不会对存在数据依赖关系的操作做重排序， 因为这种重排序会改变执行结果。但是如果操作之间不存在数据依赖关系，这些操作就可能被编译器和处理器重排序。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsIfSerialSample</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * as-if-serial语义的意思是：不管怎么重排序（编译器和处理器为了提高并行度），（单线程）
         * 程序的执行结果不能被改变。编译器、runtime和处理器都必须遵守as-if-serial语义。
         *
         * 以下例子当中1、2步存在指令重排行为，但是1、2不能与第三步指令重排
         * 也就是第3步不可能先于1、2步执行，否则将改变程序的执行结果
         */</span>
        <span class="token keyword">double</span> p <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
        <span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
        <span class="token keyword">double</span> area <span class="token operator">=</span> p <span class="token operator">*</span> r <span class="token operator">*</span> r<span class="token punctuation">;</span> <span class="token comment">//3计算面积</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="happens-before-原则"><a href="#happens-before-原则" class="header-anchor">#</a> happens-before 原则</h4> <p>只靠sychronized和volatile关键字来保证原子性、可见性以及有序性，那么编写并发程序可能会显得十分麻烦，幸运的是从JDK 5开始，Java使用新的JSR-133内存模型，提供了happens-before 原则来辅助保证程序执行的原子性、可见性以及有序性的问题，它是判断数据是否存在竞争、线程是否安全的依据;</p> <div class="custom-block tip"><p class="custom-block-title">happens-before原则:</p> <ol><li><p>程序顺序原则，即在一个线程内必须保证语义串行性，也就是说按照代码顺序执行</p></li> <li><p>锁规则 解锁(unlock)操作必然发生在后续的同一个锁的加锁(lock)之前，也就是 说，如果对于一个锁解锁后，再加锁，那么加锁的动作必须在解锁动作之后(同一个 锁)。</p></li> <li><p>volatile规则 volatile变量的写，先发生于读，这保证了volatile变量的可见性，简 单的理解就是，volatile变量在每次被线程访问时，都强迫从主内存中读该变量的值，而当该变量发生变化时，又会强迫将最新的值刷新到主内存，任何时刻，不同的 线程总是能够看到该变量的最新值。</p></li> <li><p>线程启动规则 线程的start()方法先于它的每一个动作，即如果线程A在执行线程B 的start方法之前修改了共享变量的值，那么当线程B执行start方法时，线程A对共享变量的修改对线程B可见</p></li> <li><p>传递性 A先于B ，B先于C 那么A必然先于C</p></li> <li><p>线程终止规则 线程的所有操作先于线程的终结，Thread.join()方法的作用是等待 当前执行的线程终止。假设在线程B终止之前，修改了共享变量，线程A从线程B的 join方法成功返回后，线程B对共享变量的修改将对线程A可见。</p></li> <li><p>线程中断规则 对线程 interrupt()方法的调用先行发生于被中断线程的代码检测到 中断事件的发生，可以通过Thread.interrupted()方法检测线程是否中断。</p></li> <li><p>对象终结规则对象的构造函数执行，结束先于finalize()方法</p></li></ol></div> <h2 id="_2-3-java-里的线程"><a href="#_2-3-java-里的线程" class="header-anchor">#</a> 2.3 Java 里的线程</h2> <p><a data-fancybox="" title="多线程" href="./image/javathread.jpg"><img src="/assets/img/javathread.fb6d3854.jpg" alt="多线程"></a></p> <h3 id="_2-3-1-start和run方法"><a href="#_2-3-1-start和run方法" class="header-anchor">#</a> 2.3.1 start和run方法</h3> <p>Thread类是Java里对线程概念的抽象，可以这样理解：我们通过new Thread() 其实只是 new 出一个 Thread 的实例，还没有操作系统中真正的线程挂起钩来。
只有执行了<font color="red"><strong>start()</strong></font>方法后，才实现了真正意义上的启动线程。 start()方法让一个线程进入就绪队列等待分配 cpu（<strong>cpu时间片轮转机制</strong>），分到cpu后才调用实现的<font color="red"><strong>run()</strong></font>方法。</p> <p>start()方法不能重复调用，如果重复调用会抛出异常。 而 run 方法是业务逻辑实现的地方，本质上和任意一个类的任意一个成员方法并没有任何区别，可以重复执行，也可以被单独调用。</p> <h3 id="_2-3-2-yield-方法"><a href="#_2-3-2-yield-方法" class="header-anchor">#</a> 2.3.2 yield()方法</h3> <p>使当前线程让出CPU占有权，但让出的时间是不可设定的，也不会释放锁资源。
注意：并不是每个线程都需要这个锁的，而且执行 yield( )的线 程不一定就会持有锁，我们完全可以在释放锁后再调用 yield 方法。 所有执行 yield()的线程有可能在进入到就绪状态后会被操作系统再次选中马上又被执行。</p> <p>自旋锁时可以使用yield()方法，释放cpu资源</p> <h3 id="_2-3-3-join-方法"><a href="#_2-3-3-join-方法" class="header-anchor">#</a> 2.3.3 join()方法</h3> <p>把指定的线程加入到当前线程，可以将两个交替执行的线程合并为顺序执行。 比如在线程B中调用了线程A的Join()方法，直到线程A执行完毕后，才会继续执行线程 B。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 *类说明：演示Join（）方法的使用
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseJoin</span> <span class="token punctuation">{</span>
	
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Goddess</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Goddess</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Goddess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Goddess开始排队打饭.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>thread<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">SleepTools</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//休眠2秒</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot; Goddess打饭完成.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">GoddessBoyfriend</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SleepTools</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//休眠2秒</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;GoddessBoyfriend开始排队打饭.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot; GoddessBoyfriend打饭完成.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span> lison <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GoddessBoyfriend</span> goddessBoyfriend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoddessBoyfriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> gbf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>goddessBoyfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Goddess</span> goddess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Goddess</span><span class="token punctuation">(</span>gbf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        Goddess goddess = new Goddess();</span>
        <span class="token class-name">Thread</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>goddess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        g<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gbf<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lison开始排队打饭.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        g<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SleepTools</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让主线程休眠2秒</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; lison打饭完成.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lison开始排队打饭<span class="token punctuation">..</span><span class="token punctuation">..</span>.
Goddess开始排队打饭<span class="token punctuation">..</span><span class="token punctuation">..</span>.
GoddessBoyfriend开始排队打饭<span class="token punctuation">..</span><span class="token punctuation">..</span>.
Thread-0 GoddessBoyfriend打饭完成.
Thread-1 Goddess打饭完成.
main lison打饭完成.

Process finished with <span class="token builtin class-name">exit</span> code <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-3-4-中断方法"><a href="#_2-3-4-中断方法" class="header-anchor">#</a> 2.3.4 中断方法</h3> <p>安全的中止则是其他线程通过调用某个线程 A 的<font color="red"><strong>interrupt()</strong></font>方法对其进行中断操作, 中断好比其他线程对该线程打了个招呼，“A，你要中断了”，不代表 线程 A 会立即停止自己的工作，同样的 A 线程完全可以不理会这种中断请求。 线程通过检查自身的中断标志位是否被置为<font color="red"><strong>true</strong></font>来进行响应， 线程通过方法<font color="red"><strong>isInterrupted()</strong></font>来进行判断是否被中断，也可以调用静态方法<font color="red"><strong>Thread.interrupted()来进行判断当前线程是否被中断，不过 Thread.interrupted()</strong></font> 会同时将中断标识位改写为<strong>false</strong>。</p> <p><strong>示例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>ex1<span class="token punctuation">.</span>safeend</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *类说明：如何安全中断线程
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EndThread</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>

		<span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot; interrrupt STRAT flag =&quot;</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//			while(!Thread.currentThread().isInterrupted()){</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">/*Thread.interrupted()判断之后，会将true再改为false*/</span>
<span class="token comment">//			while(!Thread.interrupted()){</span>
<span class="token comment">//			/*endThread.interrupt()将标志位置为true后，业务线程不做判断的话线程还会继续执行（协助式，不是强制式）*/</span>
<span class="token comment">//			while(true){  </span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot; is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot;inner interrrupt RUNNING flag =&quot;</span>
						<span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot; interrrupt END flag =&quot;</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot; interrrupt END flag =&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">&quot; interrrupt END flag =&quot;</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Thread</span> endThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token string">&quot;endThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		endThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		endThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//中断线程的标识位修改为true</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>如果<font color="red"><strong>一个线程处于了阻塞状态（如线程调用了 thread.sleep、thread.join、 thread.wait 等），则在线程在检查中断标示时如果发现中断标示为 true，则会在这些阻塞方法调用处抛出 InterruptedException 异常</strong></font>，</p> <p>并且在抛出异常后会立即将线程的中断标示位清除，即重新设置为 false。 不建议自定义一个取消标志位来中止线程的运行。因为 run 方法里有阻塞调用时会无法很快检测到取消标志，线程必须从阻塞调用返回后，才会检查这个取消标志。</p> <p><strong>示例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>ex1<span class="token punctuation">.</span>safeend</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *类说明：阻塞方法中抛出InterruptedException异常后，如果需要继续中断，需要手动再中断一次
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HasInterrputException</span> <span class="token punctuation">{</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
		
		<span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
							<span class="token operator">+</span><span class="token string">&quot; in InterruptedException interrupt flag is &quot;</span>
							<span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//资源释放  如果不释放，当前线程不会中断</span>
					<span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; I am extends Thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">+</span><span class="token string">&quot; interrupt flag is &quot;</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Thread</span> endThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token string">&quot;HasInterrputEx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		endThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		endThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>HasInterrputEx I am extends Thread.
HasInterrputEx I am extends Thread.
HasInterrputEx I am extends Thread.
HasInterrputEx I am extends Thread.
HasInterrputEx I am extends Thread.
HasInterrputEx <span class="token keyword">in</span> InterruptedException interrupt flag is <span class="token boolean">false</span>
HasInterrputEx I am extends Thread.
HasInterrputEx interrupt flag is <span class="token boolean">true</span>
java.lang.InterruptedException: <span class="token function">sleep</span> interrupted
	at java.lang.Thread.sleep<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
	at com.tqk.ex1.safeend.HasInterrputException<span class="token variable">$UseThread</span>.run<span class="token punctuation">(</span>HasInterrputException.java:18<span class="token punctuation">)</span>

Process finished with <span class="token builtin class-name">exit</span> code <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这种情况下使用中断会更好<br>
一、一般的阻塞方法，如 sleep 等本身就支持中断的检查，<br>
二、检查中断位的状态和检查取消标志位没什么区别，用中断位的状态还可 以避免声明取消标志位，减少资源的消耗。</p> <p><font color="red"><strong>注意：处于死锁状态的线程无法被中断</strong></font></p> <h3 id="_2-3-5-终止方法"><a href="#_2-3-5-终止方法" class="header-anchor">#</a> 2.3.5 终止方法</h3> <p>线程自然终止 要么是 run 执行完成了，要么是抛出了一个未处理的异常导致线程提前结束。</p> <p>stop 暂停、恢复和停止操作对应在线程 Thread 的 API 就是 suspend()、resume() 和 stop()。但是这些 API 是过期的，也就是不建议使用的。不建议使用的原因主 要有：以 suspend()方法为例，在调用后，线程不会释放已经占有的资源（比如 锁），而是占有着资源进入睡眠状态，这样容易引发死锁问题。同样，stop()方 法在终结一个线程时不会保证线程的资源正常释放，通常是没有给予线程完成资 源释放工作的机会，因此会导致程序可能工作在不确定状态下。正因为<font color="red"><strong>suspend()、 resume()和 stop()</strong></font>方法带来的副作用，这些方法才被标注为不建议使用的过期方法。</p> <h3 id="_2-3-6-线程的优先级"><a href="#_2-3-6-线程的优先级" class="header-anchor">#</a> 2.3.6 线程的优先级</h3> <p>在 Java 线程中，通过一个整型成员变量 priority 来控制优先级，优先级的范 围从 1~10，在线程构建的时候可以通过 setPriority(int)方法来修改优先级，默认优先级是5，优先级高的线程分配时间片的数量要多于优先级低的线程。
设置线程优先级时，针对频繁阻塞（休眠或者 I/O 操作）的线程需要设置较高优先级，而偏重计算（需要较多 CPU 时间或者偏运算）的线程则设置较低的 优先级，确保处理器不会被独占。在不同的 JVM 以及操作系统上，线程规划会存在差异，有些操作系统甚至会忽略对线程优先级的设定。</p> <h3 id="_2-3-7-线程调度"><a href="#_2-3-7-线程调度" class="header-anchor">#</a> 2.3.7 线程调度</h3> <p>线程调度是指系统为线程分配 CPU 使用权的过程，主要调度方式有两种：<br>
协同式线程调度(Cooperative Threads-Scheduling)<br>
抢占式线程调度(Preemptive Threads-Scheduling)</p> <p>使用协同式线程调度的多线程系统，线程执行的时间由线程本身来控制，线程把自己的工作执行完之后，要主动通知系统切换到另外一个线程上。使用协同式线程调度的最大好处是实现简单，由于线程要把自己的事情做完后才会通知系统进行线程切换，所以没有线程同步的问题，但是坏处也很明显，如果一个线程出了问题，则程序就会一直阻塞。</p> <p>使用抢占式线程调度的多线程系统，每个线程执行的时间以及是否切换都由系统决定。在这种情况下线程的执行时间不可控，所以不会有「一个线程导致整个进程阻塞」的问题出现。 在 Java 中，Thread.yield()可以让出 CPU 执行时间，但是对于获取，线程本身是没有办法的。对于获取 CPU 执行时间，线程唯一可以使用的手段是设置线程 优先级，Java 设置了 10 个级别的程序优先级，当两个线程同时处于 Ready 状态 时，优先级越高的线程越容易被系统选择执行。 Java 中的线程优先级是通过映射到操作系统的原生线程上实现的，所以线程 的调度最终取决于操作系统，操作系统中线程的优先级有时并不能和 Java 中的 一一对应，所以 Java 优先级并不是特别靠谱。</p> <p>所以在面试中如果遇到相关的问题，可以这样回答：<br>
Java 中的线程是通过映 射到操作系统的原生线程上实现的，所以线程的调度最终取决于操作系统，而操作系统级别，OS 是以抢占式调度线程，我们可以认为线程是抢占式的。Java 虚 拟机采用抢占式调度模型，是指优先让可运行池中优先级高的线程占用 CPU，如 果可运行池中的线程优先级相同，那么就随机选择一个线程，使其占用 CPU。处 于运行状态的线程会一直运行，直至它不得不放弃 CPU。而且操作系统中线程的 优先级有时并不能和 Java 中的一一对应，所以 Java 优先级并不是特别靠谱。但 是在 Java 中，因为 Java 没有提供安全的抢占式方法来停止线程，要安全的停止 线程只能以协作式的方式。</p> <h3 id="_2-3-8-守护线程"><a href="#_2-3-8-守护线程" class="header-anchor">#</a> 2.3.8 守护线程</h3> <p>Daemon（守护）线程是一种支持型线程，因为它主要被用作程序中后台调度以及支持性工作。这意味着，当一个 Java 虚拟机中不存在非 Daemon 线程的 时候，Java 虚拟机将会退出。可以通过调用 Thread.setDaemon(true)将线程设置 为 Daemon 线程。我们一般用不上，比如垃圾回收线程就是 Daemon 线程。</p> <p>Daemon 线程被用作完成支持性工作，但是<strong>在 Java 虚拟机退出时 Daemon 线程中的 finally 块并不一定会执行</strong>。在构建 Daemon 线程时，不能依靠 finally 块中 的内容来确保执行关闭或清理资源的逻辑。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>ex1</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 *类说明：守护线程的使用
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DaemonThread</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
							<span class="token operator">+</span> <span class="token string">&quot; I am extends Thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
						<span class="token operator">+</span> <span class="token string">&quot; interrupt flag is &quot;</span> <span class="token operator">+</span> <span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token comment">//守护线程中finally不一定起作用</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; .............finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> 
			<span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token class-name">UseThread</span> useThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		useThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置成守护线程</span>
		useThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		useThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/base/seniorJava/Java线程和操作系统线程关系-0.html" class="prev">
        1.Java线程和操作系统线程关系
      </a></span> <span class="next"><a href="/base/seniorJava/线程间的共享和协作-2.html">
        3. 线程间的共享和协作
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.20860f16.js" defer></script><script src="/assets/js/2.ac74a662.js" defer></script><script src="/assets/js/15.92ffb898.js" defer></script>
  </body>
</html>

(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{1289:function(s,t,a){s.exports=a.p+"assets/img/iptables01.391c8744.png"},1290:function(s,t,a){s.exports=a.p+"assets/img/iptables02.f73e5744.png"},1291:function(s,t,a){s.exports=a.p+"assets/img/iptables03.efbe369e.png"},1292:function(s,t,a){s.exports=a.p+"assets/img/iptables04.538da29b.png"},1293:function(s,t,a){s.exports=a.p+"assets/img/iptables05.e5e92d6a.png"},1294:function(s,t,a){s.exports=a.p+"assets/img/iptables06.5f04ff47.png"},1634:function(s,t,a){"use strict";a.r(t);var n=a(26),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"_3-iptables与防火墙"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-iptables与防火墙"}},[s._v("#")]),s._v(" 3. Iptables与防火墙")]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#_3-1-iptables、防火墙之间有啥关系"}},[s._v("3.1 iptables、防火墙之间有啥关系？")])]),n("li",[n("a",{attrs:{href:"#_3-2-iptables安装"}},[s._v("3.2 iptables安装")])]),n("li",[n("a",{attrs:{href:"#_3-3-iptables的五表五链及流量走向"}},[s._v("3.3 iptables的五表五链及流量走向")])]),n("li",[n("a",{attrs:{href:"#_3-4-iptables-commands"}},[s._v("3.4 iptables commands")])]),n("li",[n("a",{attrs:{href:"#_3-5-filter表"}},[s._v("3.5 filter表")]),n("ul",[n("li",[n("a",{attrs:{href:"#_3-5-1-usage尝鲜-filter表及规则"}},[s._v("3.5.1 usage尝鲜 filter表及规则")])]),n("li",[n("a",{attrs:{href:"#_3-5-2-案例-filter的流量过滤"}},[s._v("3.5.2 案例：filter的流量过滤")])])])]),n("li",[n("a",{attrs:{href:"#_3-6-iptables的匹配规则"}},[s._v("3.6 iptables的匹配规则")])]),n("li",[n("a",{attrs:{href:"#_3-7-补充两个小实验-加深对流量走向的理解"}},[s._v("3.7 补充两个小实验，加深对流量走向的理解")]),n("ul",[n("li",[n("a",{attrs:{href:"#_3-7-1-实验一-加深对匹配规则的了解"}},[s._v("3.7.1 实验一：加深对匹配规则的了解")])]),n("li",[n("a",{attrs:{href:"#_3-7-2-实验二-特殊的-j-log"}},[s._v("3.7.2 实验二：特殊的-j LOG")])]),n("li",[n("a",{attrs:{href:"#_3-7-3-实验总结"}},[s._v("3.7.3 实验总结")])])])]),n("li",[n("a",{attrs:{href:"#_3-8-iptables中的模块"}},[s._v("3.8 iptables中的模块")])]),n("li",[n("a",{attrs:{href:"#_3-9-nat表"}},[s._v("3.9 nat表")]),n("ul",[n("li",[n("a",{attrs:{href:"#_3-9-1-案例-使用nat表完成snat"}},[s._v("3.9.1 案例：使用nat表完成SNAT")])]),n("li",[n("a",{attrs:{href:"#_3-9-2-案例-通过nat表完成dnat"}},[s._v("3.9.2 案例：通过nat表完成DNAT")])])])]),n("li",[n("a",{attrs:{href:"#_3-10-相关配置文件"}},[s._v("3.10 相关配置文件")])]),n("li",[n("a",{attrs:{href:"#最后总结-iptables"}},[s._v("最后总结 Iptables")])])])]),n("p"),s._v(" "),n("p",[s._v("Linux的网络控制模块在内核中，叫做"),n("code",[s._v("netfilter")]),s._v("。而"),n("code",[s._v("iptables")]),s._v("是位于用户空间的一个"),n("strong",[s._v("命令行工具")]),s._v(";")]),s._v(" "),n("p",[n("code",[s._v("iptables")]),s._v("它作用在OIS7层网络模型中的第四层，"),n("strong",[s._v("用来和内核的netfilter交互，配置netfilter进而实现对网络的控制、流量的转发")]),s._v("。")]),s._v(" "),n("p",[n("code",[s._v("Natfilter")]),s._v(" 是集成到linux内核协议栈中的一套防火墙系统，用户可通过运行在用户空间的工具来把相关配置下发给Netfilter 。")]),s._v(" "),n("p",[n("code",[s._v("Netfilter")]),s._v(" 提供了整个防火墙的框架，各个协议基于Netfilter 框架来自己实现自己的防火墙功能。每个协议都有自己独立的表来存储自己的配置信息，他们之间完全独立的进行配置和运行。\n"),n("strong",[s._v("毫不夸张的说，整个linux系统的网络安全就是基于netfilter构建起来的")]),s._v("。")]),s._v(" "),n("p",[s._v("如果你想搞懂docker或者是k8s的网络调度模型，或者是去你自己的机器上查看一下他们自动生成的转发规则，那么肯定要需要对iptables有一定的认知，不然学了半天docker或者是k8s真的是只会停留在使用的这个层面上。")]),s._v(" "),n("h2",{attrs:{id:"_3-1-iptables、防火墙之间有啥关系"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-iptables、防火墙之间有啥关系"}},[s._v("#")]),s._v(" 3.1 iptables、防火墙之间有啥关系？")]),s._v(" "),n("p",[s._v("Iptables is an extremely flexible firewall utility built for Linux operating systems.")]),s._v(" "),n("p",[s._v("Whether you’re a novice Linux geek or a system administrator, there’s probably some way that iptables can be a great use to you. Read on as we show you how to configure the most versatile Linux firewall.")]),s._v(" "),n("p",[s._v("简单的说就是："),n("strong",[n("code",[s._v("iptables")]),s._v(" 是一个简单、灵活、实用的命令行工具，可以用来配置、控制 linux 防火墙")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"_3-2-iptables安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-iptables安装"}},[s._v("#")]),s._v(" 3.2 iptables安装")]),s._v(" "),n("ul",[n("li",[s._v("安装、启动、查看、开启启动")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v(" ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y iptables-services")]),s._v("\n ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum start|restart|reload|stop|status iptables")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"_3-3-iptables的五表五链及流量走向"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-iptables的五表五链及流量走向"}},[s._v("#")]),s._v(" 3.3 iptables的五表五链及流量走向")]),s._v(" "),n("p",[s._v("iptables中总共有4张表还有5条链，我们可以在链上加不同的规则。")]),s._v(" "),n("p",[s._v("五张表：filter表、nat表、mangle表、raw表、security表")]),s._v(" "),n("p",[s._v("五条链：prerouting、input、output、forward、postrouting")]),s._v(" "),n("p",[s._v("你可以通过"),n("code",[s._v("iptables -t ${表名} -nL")]),s._v("查看表上的链")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost named"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -nL")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("规则表：")]),s._v(" "),n("ol",[n("li",[s._v("filter表——三个链：INPUT、FORWARD、OUTPUT\n"),n("ul",[n("li",[s._v("作用：过滤数据包 内核模块：iptables_filter.")])])]),s._v(" "),n("li",[s._v("Nat表——三个链：PREROUTING、POSTROUTING、OUTPUT\n"),n("ul",[n("li",[s._v("作用：用于网络地址转换（IP、端口） 内核模块：iptable_nat")])])]),s._v(" "),n("li",[s._v("Mangle表——五个链：PREROUTING、POSTROUTING、INPUT、OUTPUT、FORWARD\n"),n("ul",[n("li",[s._v("作用：修改数据包的服务类型、TTL、并且可以配置路由实现QOS内核模块：iptable_mangle(别看这个表这么麻烦，咱们设置策略时几乎都不会用到它)")])])]),s._v(" "),n("li",[s._v("Raw表——两个链：OUTPUT、PREROUTING\n"),n("ul",[n("li",[s._v("作用：决定数据包是否被状态跟踪机制处理 内核模块：iptable_raw")])])])])]),s._v(" "),n("blockquote",[n("p",[s._v("规则表之间的优先顺序： "),n("strong",[n("code",[s._v("Raw——mangle——nat——filter")])])])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("规则链：")]),s._v(" "),n("ol",[n("li",[s._v("INPUT——"),n("code",[s._v("进来的数据包")]),s._v("应用此规则链中的策略")]),s._v(" "),n("li",[s._v("OUTPUT——"),n("code",[s._v("外出的数据包")]),s._v("应用此规则链中的策略")]),s._v(" "),n("li",[s._v("FORWARD——"),n("code",[s._v("转发数据包")]),s._v("时应用此规则链中的策略")]),s._v(" "),n("li",[s._v("PREROUTING——对数据包作路由选择前应用此链中的规则\n"),n("ul",[n("li",[s._v("记住！所有的数据包进来的时侯都先由这个链处理")])])]),s._v(" "),n("li",[s._v("POSTROUTING——对数据包作路由选择后应用此链中的规则\n"),n("ul",[n("li",[s._v("所有的数据包出来的时侯都先由这个链处理")])])])])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("规则链之间的优先顺序（分三种情况）：")]),s._v(" "),n("p",[s._v("第一种情况：入站数据流向")]),s._v(" "),n("ul",[n("li",[s._v("从外界到达防火墙的数据包，先被PREROUTING规则链处理（是否修改数据包地址等），之后会进行路由选择（判断该数据包应该发往何处），如果数据包 的目标主机是防火墙本机（比如说Internet用户访问防火墙主机中的web服务器的数据包），那么内核将其传给INPUT链进行处理（决定是否允许通 过等），通过以后再交给系统上层的应用程序（比如Apache服务器）进行响应。\n第二冲情况：转发数据流向")]),s._v(" "),n("li",[s._v("来自外界的数据包到达防火墙后，首先被PREROUTING规则链处理，之后会进行路由选择，如果数据包的目标地址是其它外部地址（比如局域网用户通过网 关访问QQ站点的数据包），则内核将其传递给FORWARD链进行处理（是否转发或拦截），然后再交给POSTROUTING规则链（是否修改数据包的地 址等）进行处理。\n第三种情况：出站数据流向")]),s._v(" "),n("li",[s._v("防火墙本机向外部地址发送的数据包（比如在防火墙主机中测试公网DNS服务器时），首先被OUTPUT规则链处理，之后进行路由选择，然后传递给POSTROUTING规则链（是否修改数据包的地址等）进行处理。")])])]),s._v(" "),n("p",[n("strong",[s._v("整理一下就得到了如下脑图：")])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables01.png"}},[n("img",{attrs:{src:a(1289),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("h2",{attrs:{id:"_3-4-iptables-commands"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-iptables-commands"}},[s._v("#")]),s._v(" 3.4 iptables commands")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("iptables -t "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${表名}")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${Commands}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${链名}")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${链中的规则号}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${匹配条件}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${目标动作}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("code",[s._v("表名：4张表，filter、nat、mangle、raw")])]),s._v(" "),n("p",[n("strong",[s._v("Commands")]),s._v("：尾部追加-A、检查-C、删除-D、头部插入-I、替换-R、查看全部-L、清空-F、新建chain-N、默认规则-P(默认为ACCEPT)")]),s._v(" "),n("p",[n("strong",[s._v("链名")]),s._v("：5条链，"),n("code",[s._v("PREROUTING、INPUT、FORWOARD、OUTPUT、POSTROUTING")])]),s._v(" "),n("p",[n("strong",[s._v("匹配条件")]),s._v("："),n("code",[s._v("-p")]),s._v("协议、"),n("code",[s._v("-4 、-6、-s 源地址、-d 目标地址、-i 网络接口名")])]),s._v(" "),n("p",[n("strong",[s._v("目标动作")]),s._v("：拒绝访问"),n("code",[s._v("-j REJECT")]),s._v("、允许通过"),n("code",[s._v("-j ACCEPT")]),s._v("、丢弃"),n("code",[s._v("-j DROP")]),s._v("、记录日志 "),n("code",[s._v("-j LOG")]),s._v("、源地址转换"),n("code",[s._v("-j snat")]),s._v("、目标地址转换"),n("code",[s._v("-j dnat")]),s._v("、还有"),n("code",[s._v("RETURN、QUEUE")])]),s._v(" "),n("p",[s._v("可以通过像如下查看使用帮助文档。主要可以分如下三个部分")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v(" ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables --help")]),s._v("\n Usage:    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用案例")]),s._v("\n Commands: "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 命令选项")]),s._v("\n Options:  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其他可选项")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("参考：https://wiki.centos.org/HowTos/Network/IPTables")]),s._v(" "),n("p",[s._v("这里面有一些针对linux操作系统iptables简单的教学")]),s._v(" "),n("h2",{attrs:{id:"_3-5-filter表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-filter表"}},[s._v("#")]),s._v(" 3.5 filter表")]),s._v(" "),n("h3",{attrs:{id:"_3-5-1-usage尝鲜-filter表及规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-1-usage尝鲜-filter表及规则"}},[s._v("#")]),s._v(" 3.5.1 usage尝鲜 filter表及规则")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清空防火墙")]),s._v("\n ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\n \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 (policy ACCEPT) 表示默认规则是接收")]),s._v("\n ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -L")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加规则，丢弃|接受｜拒绝｜所有进来的数据包")]),s._v("\n~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -A INPUT -j DROP|ACCEPT|REJECT|LOG")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  iptables -t filter -A INPUT -j ACCEPT")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再查看（如果还想操作某个Chain中的具体某条规则，可以加--line-numbers参数）")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -L --line-numbers")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    ACCEPT     all  --  anywhere             anywhere            \n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination  \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改默认规则")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ecs-kc1-large-2-linux-20201228182212 ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -P INPUT DROP")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ecs-kc1-large-2-linux-20201228182212 ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -L")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy DROP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nACCEPT     all  --  anywhere             anywhere\nREJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable\n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除策略 DROP类型策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -D INPUT  -j DROP")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br")])]),n("h3",{attrs:{id:"_3-5-2-案例-filter的流量过滤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-2-案例-filter的流量过滤"}},[s._v("#")]),s._v(" 3.5.2 案例：filter的流量过滤")]),s._v(" "),n("p",[s._v("比如我想将发送百度的数据包丢弃，就可以在OUTPUT Chain上添加如下的规则")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# telnet 49.232.21.151 8899")]),s._v("\nTrying "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("49.232")]),s._v(".21.151"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nConnected to "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("49.232")]),s._v(".21.151.\nEscape character is "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^]'")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -A OUTPUT -p tcp -d 49.232.21.151 -j DROP")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -L")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy DROP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nACCEPT     all  --  anywhere             anywhere            \n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination  \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 任何发送目的地是49.232.21.151，都会被drop掉")]),s._v("\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nDROP       tcp  --  anywhere             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("49.232")]),s._v(".21.151 \n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试一下，结果夯住")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# telnet 49.232.21.151 8899")]),s._v("\nTrying "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("49.232")]),s._v(".21.151"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("ul",[n("li",[s._v("删除过滤规则，语法:"),n("code",[s._v("iptables -t 表名 -D 链名 规则序号")])])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -D OUTPUT 1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L --line-number")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy DROP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    ACCEPT     all  --  anywhere             anywhere            \n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ul",[n("li",[s._v("在指定表的指定链中的指定的位置插入规则")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -I 默认是在头部插入，也可以指定插入的位置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ecs-kc1-large-2-linux-20201228182212 ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I INPUT 2 -j REJECT")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ecs-kc1-large-2-linux-20201228182212 ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L --line-numbers")]),s._v("\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    ACCEPT     all  --  anywhere             anywhere\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable\n\nChain FORWARD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnum  target     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("h2",{attrs:{id:"_3-6-iptables的匹配规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-iptables的匹配规则"}},[s._v("#")]),s._v(" 3.6 iptables的匹配规则")]),s._v(" "),n("p",[s._v("什么是匹配规则？")]),s._v(" "),n("p",[s._v("这个东西并不难理解，他其实就是一种描述。比如说：我想丢弃来自A的流量，\n体现在iptables语法上就是："),n("code",[s._v("iptables -t filter -A INPUT -s ${A的地址} -j DROP")]),s._v(" ，这段话中的来自A其实就是匹配规则。")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("常见的规则如下：")]),s._v(" "),n("p",[n("strong",[s._v("源地址")]),s._v("："),n("code",[s._v("-s 192.168.1.0/24")])]),s._v(" "),n("p",[n("strong",[s._v("目标地址")]),s._v("："),n("code",[s._v("-d 192.168.1.11")])]),s._v(" "),n("p",[n("strong",[s._v("协议")]),s._v("："),n("code",[s._v("-p tcp|udp|icmp")])]),s._v(" "),n("p",[n("strong",[s._v("从哪个网卡进来")]),s._v("："),n("code",[s._v("-i eth0|lo")])]),s._v(" "),n("p",[n("strong",[s._v("从哪个网卡出去")]),s._v("："),n("code",[s._v("-o eth0|lo")])]),s._v(" "),n("p",[n("strong",[s._v("目标端口（必须制定协议）")]),s._v("："),n("code",[s._v("-p tcp|udp --dport 8080")])]),s._v(" "),n("p",[n("strong",[s._v("源端口（必须制定协议）")]),s._v("："),n("code",[s._v("-p tcp|udp --sport 8080")])])]),s._v(" "),n("h2",{attrs:{id:"_3-7-补充两个小实验-加深对流量走向的理解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-补充两个小实验-加深对流量走向的理解"}},[s._v("#")]),s._v(" 3.7 补充两个小实验，加深对流量走向的理解")]),s._v(" "),n("h3",{attrs:{id:"_3-7-1-实验一-加深对匹配规则的了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-1-实验一-加深对匹配规则的了解"}},[s._v("#")]),s._v(" 3.7.1 实验一：加深对匹配规则的了解")]),s._v(" "),n("p",[s._v("通过这个实验搞清楚：当数据包命中了该链上的某一个规则后，还会继续往下匹配该链上的其他规则吗？")]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables02.png"}},[n("img",{attrs:{src:a(1290),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("p",[s._v("我们在"),n("code",[s._v("10.4.4.8")]),s._v("的fitler表、INPUT链上添加如下规则")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("iptables -t filter -A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".4.11 -j DROP\niptables -t filter -A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".4.12 -j ACCEPT\niptables -t filter -A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".4.11 -j ACCEPT\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("问：ip为10.4.4.12的机器能ping通10.4.4.8吗？")]),s._v(" "),n("p",[s._v("答：肯定能")]),s._v(" "),n("p",[s._v("问：ip为10.4.4.11的机器能ping通10.4.4.8吗？")]),s._v(" "),n("p",[s._v("答：不能")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("流量的走向如下图，它会挨个经过各表的input链，其中当然也包含我们加了DROP规则的filter表的INPUT链。\n"),n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables03.png"}},[n("img",{attrs:{src:a(1291),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("p",[s._v("而你仔细看上面的规则，第一条是DROP、第三条是ACCEPT。再结合最终实验的结果是ping不通，"),n("strong",[s._v("所以不难猜出流量确实会依次经过链上的规则，但是当有命中的规则后，会去执行该规则-j参数指定的动作。不再往下匹配本链上的其他规则")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"_3-7-2-实验二-特殊的-j-log"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-2-实验二-特殊的-j-log"}},[s._v("#")]),s._v(" 3.7.2 实验二：特殊的-j LOG")]),s._v(" "),n("p",[s._v("实验二思路如下图：")]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables04.png"}},[n("img",{attrs:{src:a(1292),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("ul",[n("li",[s._v("我们在10.4.4.8上添加如下规则")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清空现有的规则")]),s._v("\niptables -t filter -F\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改默认规则，默认DROP所有流量")]),s._v("\niptables -t filter -P INPUT DROP\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再添加如下两条规则")]),s._v("\niptables -t filter -A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".4.11 -j LOG\niptables -t filter -A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.4")]),s._v(".4.11  -j ACCEPT\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("问：从10.4.4.12ping10.4.4.8能通吗？")]),s._v(" "),n("p",[s._v("答：不能，因为10.4.4.8的filter表的INPUT链的默认规则是DROP，意思是如果没有命令filter表INPUT链中的其他规则，那么就会DROP这个数据包。所以很显然，10.4.4.12的数据包会被drop")]),s._v(" "),n("p",[s._v("问：从10.4.4.11ping10.4.4.8能通吗？")]),s._v(" "),n("p",[s._v("答：可以。")]),s._v(" "),n("p",[s._v("大概的逻辑我用下面的伪代码通俗表达出来")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 遍历filter.input链上的所有规则")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" _"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("pattern "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" range filter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INPUT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("patterns"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" pattern"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("动作 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" `"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("j LOG`  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将日志记录进 /var/log/message")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("continue")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" pattern "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行该规则定义的动作")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h3",{attrs:{id:"_3-7-3-实验总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-3-实验总结"}},[s._v("#")]),s._v(" 3.7.3 实验总结")]),s._v(" "),n("p",[s._v("iptables中每条链下面的规则处理顺序是从上到下逐条遍历的，除非碰到了"),n("code",[s._v("DROP、REJECT、RETURN")]),s._v("。")]),s._v(" "),n("p",[s._v("还有就是如果定义的行为是JUMP，那就会相应的jump到指定链上的指定规则上，如下：\n"),n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables05.png"}},[n("img",{attrs:{src:a(1293),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("h2",{attrs:{id:"_3-8-iptables中的模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-iptables中的模块"}},[s._v("#")]),s._v(" 3.8 iptables中的模块")]),s._v(" "),n("ul",[n("li",[s._v("多端口\nCase: 可以在命令中像下面这样指定多个连续的端口")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("iptables -t "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${表名}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${commands}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${chain}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${规则号}")]),s._v(" --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":30 -j "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${动作}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其中的20:30表示20和30之间的所有端口")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("想指定多个不连续的端口可以使用iptables的multiport")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看帮助文档")]),s._v("\n~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -m multiport --help")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nmultiport match options:\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --source-ports port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(",port:port,port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n --sports "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    match "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --destination-ports port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(",port:port,port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n --dports "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    match destination port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --ports port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(",port:port,port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    match both "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" and destination port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#命令例子")]),s._v("\niptables -t "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${表名}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${commands}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${chain}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${规则号}")]),s._v("  \n     "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${-p 协议}")]),s._v(" -m multiport --dports "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20,30")]),s._v(" -j "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${动作}")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#相当于如下两行命令")]),s._v("\niptables -t "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${表名}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${commands}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${chain}")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${规则号}")]),s._v(" -p "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${协议}")]),s._v(" --dprot "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" -j "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${动作}")]),s._v("\niptables -t "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${表名}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${commands}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${chain}")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${规则号}")]),s._v(" -p "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${协议}")]),s._v(" --dprot "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" -j "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${动作}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("ul",[n("li",[s._v("ip范围")])]),s._v(" "),n("p",[s._v("查看帮助文档")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -m iprange --help")]),s._v("\niprange match options:\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --src-range ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    Match "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" IP "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the specified range\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --dst-range ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    Match destination IP "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the specified range\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 案例：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拒绝指定范围内的ip访问自己80端口")]),s._v("\niptables -t filter -A INPUT \n     -m -iprange --src-range "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.2-10.10.10.5\n     -p tcp --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n         -j DROP\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ul",[n("li",[s._v("连接状态")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("查看帮助文档：\n\n~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -m state --help")]),s._v("\nstate match options:\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --state "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INVALID"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("ESTABLISHED"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("NEW"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("RELATED"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("UNTRACKED"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(","),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ol",[n("li",[n("p",[s._v("INVALID：无效连接")])]),s._v(" "),n("li",[n("p",[s._v("NEW：首次访问和服务端建立的连接，之后和服务端的交互时连接的state不再是NEW")])]),s._v(" "),n("li",[n("p",[s._v("ESTABLISHED：连接完成，和服务端建立连接之后的所有交互，包括访问服务端、服务器的响应。")])]),s._v(" "),n("li",[n("p",[s._v("RELATED：相关联的连接，如ftp使用20、21建立连接，再使用其他端口交互数据时的这个连接就是和第一次建立连接时的相关的连接。state也就是RELATED。")])])]),s._v(" "),n("blockquote",[n("p",[s._v('想让防火墙识别出连接的状态为RELATED，需要让iptable加载插件vi /etc/sysconfig/iptables-config，然后修改：IPTABLES_MODULES="nf_conntrack_ftp"，再重启防火墙即可。')])]),s._v(" "),n("p",[s._v("案例：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 放行所有状态为ESTABLISHD的数据包")]),s._v("\niptables -f filter -A OUTPT\n     -m state --state ESTABLISHED\n     -j ACCEPT\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"_3-9-nat表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-nat表"}},[s._v("#")]),s._v(" 3.9 nat表")]),s._v(" "),n("p",[s._v("作用：用于网络地址转换（IP、端口） 内核模块：iptable_nat")]),s._v(" "),n("p",[s._v("查看NAT表，可以找到它有4条链，如下")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v(" ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t nat -L")]),s._v("\nChain PREROUTING "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain INPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain OUTPUT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n\nChain POSTROUTING "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("通常我们会通过给nat表中的PREROUTING、POSTROUTING这两条链添加规则来实现SNAT、DNAT如下:")]),s._v(" "),n("p",[n("code",[s._v("-j SNAT")]),s._v(" ，源地址转换说的时在数据包发送出去前，我们将数据包的src ip修改成期望的值。所以这个规则需要添加在POSTROUTING中。")]),s._v(" "),n("p",[n("code",[s._v("-j DNAT")]),s._v("，目标地址转换？比如发送者发过来的数据包的dst ip = A，那目标地址转换就是允许我们修改dst ip=B，也就是将数据包发送给B处理，这个过程对发送者来说是感知不到的，他会坚定的认为自己的数据包会发往A，而且B也感知不到这个过程，它甚至会认为这个数据包从一开始就是发给他的。")]),s._v(" "),n("p",[n("code",[s._v("-j MASQUERADE")]),s._v("，地址伪装")]),s._v(" "),n("h3",{attrs:{id:"_3-9-1-案例-使用nat表完成snat"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-1-案例-使用nat表完成snat"}},[s._v("#")]),s._v(" 3.9.1 案例：使用nat表完成SNAT")]),s._v(" "),n("ul",[n("li",[s._v("案例：将src ip = 10.10.10.10转换成src ip = 22.22.22.22然后将数据包发给期望的目的ip所在的机器")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("iptables -t nat -A POSTROUTING -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.10 -j SNAT --to "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22.22")]),s._v(".22.1\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果公网地址不停的变化，可以像下面这样设置：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# step1:使用MASQUERADE做地址伪装，意思是我们不用手动指定将src ip转成哪个ip")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# step2:让本机自己去查有没有去往dst ip的通路，如果有的话，就用这个通路的ip作为src ip")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# step3:另一边数据包的接收者来说，src ip就是step2中自动找到的通路网口的ip地址")]),s._v("\niptables -t nat -A POSTROUTING -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.10 -j MASQUERADE\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[n("strong",[s._v("总结")]),s._v("：源地址转换一般是数据包从私网流向公网时做的转换，将私网地址转换成公网地址，会将这个转换记录记录到地址转换表中，目的是为了数据包从公网回来时，能正确的回到私网中发送请求的机器中。")]),s._v(" "),n("p",[n("strong",[s._v("LAN接口 WAN接口 使用的技术")])]),s._v(" "),n("h3",{attrs:{id:"_3-9-2-案例-通过nat表完成dnat"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-2-案例-通过nat表完成dnat"}},[s._v("#")]),s._v(" 3.9.2 案例：通过nat表完成DNAT")]),s._v(" "),n("p",[s._v("DNAT全称："),n("code",[s._v("Destnation Network Address Tranlater目标地址改写")]),s._v("。")]),s._v(" "),n("p",[s._v("当我 telnet 192.168.0.2 55时，我期望tables规则将我的目标地址改写成20.181.38.148:80")]),s._v(" "),n("p",[s._v("先尝试telnet 192.168.0.2 55，发现没有任何route去该host")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# telnet 192.168.0.2 55")]),s._v("\nTrying "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ntelnet: connect to address "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2: No route to "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("好，再使用iptable添加DNAT规则，命令如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" iptables -t nat -A OUTPUT -p tcp -d "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2 --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v(" -j DNAT --to-destination "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("220.181")]),s._v(".38.148:80\n \n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参数解析")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -A 表示append，追加iptable规则")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# OUTPUT 是内核的回调钩子，流量被转发出去前会经过这个阶段，DNAT的规则就加在这个阶段。")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p protocol 协议")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -d destnation 目标地址")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --dport 目标口")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -j jump 跳转（跳转到目标规则）")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --to-destination 目标地址")]),s._v("\n \n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 命令含义：")]),s._v("\n 当OUTPUT Chain上的数据包使用的协议是tcp、目标地址是192.168.0.2、目标端口是55时，\n 我跳转到DNAT模式，将目标地址改成：220.181.38.148:80\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[s._v("再尝试telnet 192.168.0.2 55，会发现链路通了！")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# telnet 192.168.0.2 55")]),s._v("\nTrying "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nConnected to "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.2.\nEscape character is "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^]'")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\nConnection closed by foreign host.\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("再查看iptable规则，如下：")]),s._v(" "),n("blockquote",[n("p",[s._v("可以看到有很多的Chain比如上面的OUTPUT就是一条链，它是操作系统的一个hook，当请求被发送出去时会经过这个hook。")])]),s._v(" "),n("blockquote",[n("p",[s._v("还有就是通过iptable的DNAT能力可以做tizi！你仔细琢磨一下，原理就在上面的图中哦～")])]),s._v(" "),n("p",[s._v("补充典型应用场景：公司有自己建设的机房，机房中机器的ip都在：10.10.10.0/24网段，机房对外提供服务就需要通过网络设备暴露公网一个ip，比如是：22.22.22.1:80")]),s._v(" "),n("p",[s._v("当网络设备收到dst ip = 22.22.22.1:80的数据包时，就会做DNAT转换，将dst ip转换成内网中的某台服务器的ip，比如就是:dtp ip = 10.10.10.10，然后将数据包转发给这台机器让它处理数据包。")]),s._v(" "),n("h2",{attrs:{id:"_3-10-相关配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-10-相关配置文件"}},[s._v("#")]),s._v(" 3.10 相关配置文件")]),s._v(" "),n("p",[s._v("iptables的配置文件在/etc/sysconfig目录如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("-rw-------  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("635")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v(" ip6tables\n-rw-------  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2134")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v(" ip6tables-config\n-rw-------  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("550")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v(" iptables\n-rw-------  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2116")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v(" iptables-config\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("iptables启动时会加载这个配置文件中定义好的各表、链中的规则")]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"iptables的五表五链及流量走向",href:"./images/iptables06.png"}},[n("img",{attrs:{src:a(1294),alt:"iptables的五表五链及流量走向"}})])]),s._v(" "),n("p",[s._v("一般我们会先使用iptables修改各种规则，如果想让iptables启动、重启时，继续使用你刚才修改的配置，我们就会考虑使用iptables-save命令将规则导出为配置文件。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出某张表的iptables规则")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@bairimeng ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables-save -t filter > 1.bak")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出全力量iptables规则")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@bairimeng ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables-save > 2.bak")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("再将文件中的内容拷贝进/etc/sysconfig/iptables中即可")]),s._v(" "),n("h2",{attrs:{id:"最后总结-iptables"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最后总结-iptables"}},[s._v("#")]),s._v(" 最后总结 Iptables")]),s._v(" "),n("p",[n("code",[s._v("iptables")]),s._v("它作用在OIS7层网络模型中的第四层，"),n("strong",[s._v("用来和内核的netfilter交互，配置netfilter进而实现对网络的控制、流量的转发")]),s._v("。")]),s._v(" "),n("p",[n("code",[s._v("Natfilter")]),s._v(" 是集成到linux内核协议栈中的一套防火墙系统，用户可通过运行在用户空间的工具来把相关配置下发给Netfilter")]),s._v(" "),n("p",[s._v("十三、参考资料\n1、https://zjj2wry.github.io/network/iptables/")]),s._v(" "),n("p",[s._v("2、维基百科：https://en.wikipedia.org/wiki/Iptables")]),s._v(" "),n("p",[s._v("3、man page https://linux.die.net/man/8/iptables")]),s._v(" "),n("p",[s._v("4、centos iptables wiki：https://wiki.centos.org/HowTos/Network/IPTables")]),s._v(" "),n("p",[s._v("5、ibm：https://www.ibm.com/docs/en/linux-on-systems?topic=tests-firewall-iptables-rules")]),s._v(" "),n("p",[s._v("6、参考：《Kubernetes网络权威指南》")])])}),[],!1,null,null,null);t.default=e.exports}}]);
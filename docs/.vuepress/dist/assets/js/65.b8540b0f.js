(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{1437:function(s,t,a){"use strict";a.r(t);var e=a(26),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"_8-mysql慢查询"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-mysql慢查询"}},[s._v("#")]),s._v(" 8. Mysql慢查询")]),s._v(" "),e("p",[s._v("慢查询日志，顾名思义，就是查询慢的日志，是指 mysql 记录所有执行超过 long_query_time 参数设定的时间阈值的 SQL 语句的日志。该日志能为 SQL 语句的优化带来很好的帮助。默 认情况下，慢查询日志是关闭的，要使用慢查询日志功能，首先要开启慢查询日志功能。")]),s._v(" "),e("h2",{attrs:{id:"_8-1-慢查询配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-慢查询配置"}},[s._v("#")]),s._v(" 8.1 慢查询配置")]),s._v(" "),e("p",[s._v("我们已经知道慢查询日志可以帮助定位可能存在问题的 SQL 语句，从而进行 SQL 语句层面的优化。但是默认值为关闭的，需要我们手动开启。")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" VARIABLES "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slow_query_log'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" slow_query_log"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"slow_query_log",href:"./image/slow_query_log.jpg"}},[e("img",{attrs:{src:a(700),alt:"slow_query_log"}})])]),s._v(" "),e("p",[s._v("但是多慢算慢？MySQL 中可以设定一个阈值，将运行时间超过该值的所有 SQL 语句都记录到慢查询日志中。long_query_time 参数就是这个阈值。默认值为 10，代表 10 秒。")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" VARIABLES "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%long_query_time%'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--当然也可以设置 ")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" long_query_time"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---默认 10 秒，这里为了演示方便设置为 0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"long_query_time",href:"./image/long_query_time.jpg"}},[e("img",{attrs:{src:a(701),alt:"long_query_time"}})])]),s._v(" "),e("p",[s._v("同时对于没有运行的 SQL 语句没有使用索引，则 MySQL 数据库也可以将这 条 SQL 语句记录到慢查询日志文件，控制参数是：")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" VARIABLES "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%log_queries_not_using_indexes%'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" log_queries_not_using_indexes"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"log_queries_not_using_indexes",href:"./image/log_queries_not_using_indexes.jpg"}},[e("img",{attrs:{src:a(702),alt:"log_queries_not_using_indexes"}})])]),s._v(" "),e("p",[s._v("对于产生的慢查询日志，可以指定输出的位置，通过参数 log_output 来控制， 可以输出到[TABLE][FILE][FILE,TABLE]。比如")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" VARIABLES "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'log_output'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" log_output"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'FILE,TABLE'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("缺省是输出到文件，我们的配置把慢查询 输出到表，不过一般不推荐输出到表。\n"),e("a",{attrs:{"data-fancybox":"",title:"log_output",href:"./image/log_output.jpg"}},[e("img",{attrs:{src:a(703),alt:"log_output"}})])]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("总结")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("slow_query_log")]),s._v(" 启动停止慢查询日志")]),s._v(" "),e("li",[e("strong",[s._v("slow_query_log_file")]),s._v(" 指定慢查询日志得存储路径及文件（默认和数据 文件放一起）")]),s._v(" "),e("li",[e("strong",[s._v("long_query_time")]),s._v(" 指定记录慢查询日志 SQL 执行时间得伐值（单位： 秒，默认 10 秒）")]),s._v(" "),e("li",[e("strong",[s._v("log_queries_not_using_indexes")]),s._v(" 是否记录未使用索引的 SQL")]),s._v(" "),e("li",[e("strong",[s._v("log_output")]),s._v(" 日志存放的地方可以是[TABLE][FILE][FILE,TABLE]")])])]),s._v(" "),e("h2",{attrs:{id:"_8-2-慢查询解读分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-慢查询解读分析"}},[s._v("#")]),s._v(" 8.2 慢查询解读分析")]),s._v(" "),e("h3",{attrs:{id:"_8-2-1-slow-log日志文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-1-slow-log日志文件"}},[s._v("#")]),s._v(" 8.2.1 slow.log日志文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#日志文件目录")]),s._v("\nroot@8559b90888a5:/var/lib/mysql"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/var/lib/mysql\nroot@8559b90888a5:/var/lib/mysql"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -lrt *slow")]),s._v("\n-rw-r----- "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("24444")]),s._v(" Nov "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":24 8559b90888a5-slow.log\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"showquery",href:"./image/showquery.jpg"}},[e("img",{attrs:{src:a(704),alt:"showquery"}})])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Time: 2021-11-14T22:24:39.535773Z")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User@Host: root[root] @  [113.124.224.168]  Id:   137")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Query_time: 0.000232  Lock_time: 0.000122 Rows_sent: 2  Rows_examined: 2")]),s._v("\nSET "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timestamp")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1636928679")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from test_int_n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("slow.log日志文件分析")]),s._v(" "),e("p",[s._v("Time: 2021-11-14T22:24:39.535773Z：查询执行时间"),e("br"),s._v("\nUser@Host: root[root] @  [113.124.224.168]  Id:   137：用户名 、用户的 IP 信 息、线程 ID 号"),e("br"),s._v("\nQuery_time: 0.000232 :执行花费的时长【单位：毫秒】"),e("br"),s._v("\nLock_time: 0.000122 :执行获得锁的时长"),e("br"),s._v("\nRows_sent: 2 :获得的结果行数"),e("br"),s._v("\nRows_examined: 2 :扫描的数据行数"),e("br"),s._v("\nSET timestamp：这 SQL 执行的具体时间"),e("br"),s._v("\n最后一行：执行的 SQL 语句")])]),s._v(" "),e("h3",{attrs:{id:"_8-2-2-mysqldumpslow语法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-2-mysqldumpslow语法"}},[s._v("#")]),s._v(" 8.2.2 mysqldumpslow语法")]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("语法")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("mysqldumpslow -s r -t "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" slow-mysql.log \n-s order "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c,t,l,r,at,al,ar"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \nc:总次数 \nt:总时间 \nl:锁的时间\nr:获得的结果行数\nat,al,ar :指 t,l,r 平均数 \n【例如：at "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 总时间/总次数】 \n-s 对结果进行排序，怎么排，根据后面所带的 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c,t,l,r,at,al,ar"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，缺省为at \n-t NUM just show the "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" n queries：仅显示前 n 条查询 \n-g PATTERN grep: only consider stmts that include this string：通过 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" 来 筛选语句。\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("./mysqldumpslow -s t -t "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" 8559b90888a5-slow.log \n./mysqldumpslow -s t -t "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" 8559b90888a5-slow.log -g "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"slowquery",href:"./image/slowquery.jpg"}},[e("img",{attrs:{src:a(705),alt:"showquery"}})])])])}),[],!1,null,null,null);t.default=n.exports},700:function(s,t,a){s.exports=a.p+"assets/img/slow_query_log.01c1b514.jpg"},701:function(s,t,a){s.exports=a.p+"assets/img/long_query_time.fbd1106c.jpg"},702:function(s,t,a){s.exports=a.p+"assets/img/log_queries_not_using_indexes.c098f195.jpg"},703:function(s,t,a){s.exports=a.p+"assets/img/log_output.828b1630.jpg"},704:function(s,t,a){s.exports=a.p+"assets/img/showquery.4dd5edf3.jpg"},705:function(s,t,a){s.exports=a.p+"assets/img/slowquery.4b85230e.jpg"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{1269:function(s,a,t){s.exports=t.p+"assets/img/image-20201012163807688.1e5c650f.png"},1270:function(s,a,t){s.exports=t.p+"assets/img/image-20201012163817357.11799d84.png"},1271:function(s,a,t){s.exports=t.p+"assets/img/image-20201012163836255.64f689bf.png"},1272:function(s,a,t){s.exports=t.p+"assets/img/image-20201012163840741.1d058d8d.png"},1273:function(s,a,t){s.exports=t.p+"assets/img/image-20201012162304285.374a413f.png"},1616:function(s,a,t){"use strict";t.r(a);var n=t(26),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"_6-nginx搭建高可用集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-nginx搭建高可用集群"}},[s._v("#")]),s._v(" 6. Nginx搭建高可用集群")]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#_6-1-配置高可用准备工作"}},[s._v("6.1 配置高可用准备工作")])]),n("li",[n("a",{attrs:{href:"#_6-2-在两台服务中-安装keepalived"}},[s._v("6.2 在两台服务中 安装keepalived")])]),n("li",[n("a",{attrs:{href:"#_6-3-完成高可用配置-主从配置"}},[s._v("6.3 完成高可用配置 ( 主从配置 )")])]),n("li",[n("a",{attrs:{href:"#_6-3-最终测试"}},[s._v("6.3 最终测试")])])])]),n("p"),s._v(" "),n("h2",{attrs:{id:"_6-1-配置高可用准备工作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-配置高可用准备工作"}},[s._v("#")]),s._v(" 6.1 配置高可用准备工作")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("需要两台服务器 192.168.17.129 和192.168.17.131")])]),s._v(" "),n("li",[n("p",[s._v("在两台服务器 安装 nginx")])]),s._v(" "),n("li",[n("p",[s._v("在两台服务器安装 keepalived")])])]),s._v(" "),n("h2",{attrs:{id:"_6-2-在两台服务中-安装keepalived"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-在两台服务中-安装keepalived"}},[s._v("#")]),s._v(" 6.2 在两台服务中 安装keepalived")]),s._v(" "),n("ol",[n("li",[s._v("使用 yum 命令安装")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("yum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" keepalived -y\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("安装后 在 etc里面生成目录 keepalive 有文件 keepalivec.conf配置文件")])]),s._v(" "),n("h2",{attrs:{id:"_6-3-完成高可用配置-主从配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-完成高可用配置-主从配置"}},[s._v("#")]),s._v(" 6.3 完成高可用配置 ( 主从配置 )")]),s._v(" "),n("ol",[n("li",[s._v("修改/etc/keepalived/keepalivec.conf配置文件")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("global_defs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tnotification_email "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tacassen@firewall.loc\n\t\tfailover@firewall.loc\n\t\tsysadmin@firewall.loc\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tnotification_email_from Alexandre.Cassen@firewall.loc\n\t\tsmtp_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("122.51")]),s._v(".156.245\n\t\tsmtp_connect_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n\t\trouter_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("122.51")]),s._v(".156.245\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\nvrrp_script chk_http_port "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/src/nginx_check.sh"')]),s._v("\n    interval "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（检测脚本执行的间隔）")]),s._v("\n    weight "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\nvrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份服务器上将MASTER 改为BACKUP  ")]),s._v("\n\tinterface eth0  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网卡")]),s._v("\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主、备机的virtual_router_id必须相同")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主、备机取不同的优先级，主机值较大，备份机值较小")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".200.16\n        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".200.17\n        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".200.18\n\t\t// VRRP H虚拟地址 云服务器上需要在同一网段\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("在/usr/local/src 添加检测脚本")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查nginx进程是否存在")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$A")]),s._v(" -eq "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果不存在尝试重启")]),s._v("\n    /usr/local/nginx/sbin/nginx\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果重启之后还是不行，进行 keepalived 切换")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" -eq "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("killall")]),s._v(" keepalived\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("把两台服务器上nginx和keepalived启动")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动nginx：")]),s._v("\n./nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动keepalived：")]),s._v("\nsystemctl start keepalived.service\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"_6-3-最终测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-最终测试"}},[s._v("#")]),s._v(" 6.3 最终测试")]),s._v(" "),n("ol",[n("li",[s._v("在浏览器地址栏输入虚拟ip地址192.168.17.50")])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"image-20201012163807688",href:"./image/image-20201012163807688.png"}},[n("img",{attrs:{src:t(1269),alt:"image-20201012163807688"}})])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"image-20201012163817357",href:"./image/image-20201012163817357.png"}},[n("img",{attrs:{src:t(1270),alt:"image-20201012163817357"}})])]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[s._v("把主服务器（192.168.17.129）nginx和keepalived停止，再输入192.168.17.50")])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"image-20201012163836255",href:"./image/image-20201012163836255.png"}},[n("img",{attrs:{src:t(1271),alt:"image-20201012163836255"}})])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"image-20201012163840741",href:"./image/image-20201012163840741.png"}},[n("img",{attrs:{src:t(1272),alt:"image-20201012163840741"}})])]),s._v(" "),n("p",[n("a",{attrs:{"data-fancybox":"",title:"image-20201012162304285",href:"./image/image-20201012162304285.png"}},[n("img",{attrs:{src:t(1273),alt:"image-20201012162304285"}})])])])}),[],!1,null,null,null);a.default=e.exports}}]);
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. ShardingJDBC实战 | TQK的个人博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="TQK的个人博客">
    <meta name="author" content="冰岛红茶">
    <meta name="keywords" content="个人博客 ，java ，后端">
    
    <link rel="preload" href="/assets/css/0.styles.7055dd22.css" as="style"><link rel="preload" href="/assets/js/app.91f727ae.js" as="script"><link rel="preload" href="/assets/js/2.46e95b75.js" as="script"><link rel="preload" href="/assets/js/95.ba72d1bd.js" as="script"><link rel="prefetch" href="/assets/js/10.dd8b84d5.js"><link rel="prefetch" href="/assets/js/100.26af122b.js"><link rel="prefetch" href="/assets/js/101.7a65cae3.js"><link rel="prefetch" href="/assets/js/102.a8d3e557.js"><link rel="prefetch" href="/assets/js/103.2ab17152.js"><link rel="prefetch" href="/assets/js/104.3f522da2.js"><link rel="prefetch" href="/assets/js/105.c721dc7c.js"><link rel="prefetch" href="/assets/js/106.8ce87e81.js"><link rel="prefetch" href="/assets/js/107.e671bc62.js"><link rel="prefetch" href="/assets/js/108.77fdf057.js"><link rel="prefetch" href="/assets/js/109.34d76c26.js"><link rel="prefetch" href="/assets/js/11.2218f00e.js"><link rel="prefetch" href="/assets/js/110.0c21bed1.js"><link rel="prefetch" href="/assets/js/111.7c4a1007.js"><link rel="prefetch" href="/assets/js/112.b9d5e38a.js"><link rel="prefetch" href="/assets/js/113.7db11750.js"><link rel="prefetch" href="/assets/js/114.d0bd73b3.js"><link rel="prefetch" href="/assets/js/115.c5b1bd4b.js"><link rel="prefetch" href="/assets/js/116.942fc1be.js"><link rel="prefetch" href="/assets/js/117.a0046772.js"><link rel="prefetch" href="/assets/js/118.70517bac.js"><link rel="prefetch" href="/assets/js/119.38251d2f.js"><link rel="prefetch" href="/assets/js/12.d2ae52db.js"><link rel="prefetch" href="/assets/js/120.312e49e5.js"><link rel="prefetch" href="/assets/js/121.d9317c6e.js"><link rel="prefetch" href="/assets/js/122.8d76ff32.js"><link rel="prefetch" href="/assets/js/123.2803fda2.js"><link rel="prefetch" href="/assets/js/124.1625a215.js"><link rel="prefetch" href="/assets/js/125.7a1578e9.js"><link rel="prefetch" href="/assets/js/126.d50c5d93.js"><link rel="prefetch" href="/assets/js/127.797cbe0c.js"><link rel="prefetch" href="/assets/js/128.caa919ca.js"><link rel="prefetch" href="/assets/js/129.5751cafd.js"><link rel="prefetch" href="/assets/js/13.46f22946.js"><link rel="prefetch" href="/assets/js/130.a4f21590.js"><link rel="prefetch" href="/assets/js/131.574d55c5.js"><link rel="prefetch" href="/assets/js/132.05f44b92.js"><link rel="prefetch" href="/assets/js/133.4ac63e5c.js"><link rel="prefetch" href="/assets/js/134.a9f5ef0b.js"><link rel="prefetch" href="/assets/js/135.4c627dcc.js"><link rel="prefetch" href="/assets/js/136.173182d9.js"><link rel="prefetch" href="/assets/js/137.91834a44.js"><link rel="prefetch" href="/assets/js/138.0ae8a4c1.js"><link rel="prefetch" href="/assets/js/139.81f8d84e.js"><link rel="prefetch" href="/assets/js/14.d1489178.js"><link rel="prefetch" href="/assets/js/140.8f406fa8.js"><link rel="prefetch" href="/assets/js/141.9bf71611.js"><link rel="prefetch" href="/assets/js/142.b49d2f20.js"><link rel="prefetch" href="/assets/js/143.719304d2.js"><link rel="prefetch" href="/assets/js/144.d0ff8183.js"><link rel="prefetch" href="/assets/js/145.567feef5.js"><link rel="prefetch" href="/assets/js/146.3cc501b1.js"><link rel="prefetch" href="/assets/js/147.b31d39a8.js"><link rel="prefetch" href="/assets/js/148.8a082fa9.js"><link rel="prefetch" href="/assets/js/149.09ad156e.js"><link rel="prefetch" href="/assets/js/15.42d89873.js"><link rel="prefetch" href="/assets/js/150.e6c7ccb8.js"><link rel="prefetch" href="/assets/js/151.3147b000.js"><link rel="prefetch" href="/assets/js/152.d6aafd62.js"><link rel="prefetch" href="/assets/js/153.bb09aa57.js"><link rel="prefetch" href="/assets/js/154.4b0e4f26.js"><link rel="prefetch" href="/assets/js/155.8a90279e.js"><link rel="prefetch" href="/assets/js/156.8d8bf8a2.js"><link rel="prefetch" href="/assets/js/157.54e8cded.js"><link rel="prefetch" href="/assets/js/158.6e28ec43.js"><link rel="prefetch" href="/assets/js/159.a26a63f4.js"><link rel="prefetch" href="/assets/js/16.ee7d21de.js"><link rel="prefetch" href="/assets/js/160.0d206ac5.js"><link rel="prefetch" href="/assets/js/161.cf7c8f23.js"><link rel="prefetch" href="/assets/js/162.5a0a22bb.js"><link rel="prefetch" href="/assets/js/163.6075c000.js"><link rel="prefetch" href="/assets/js/164.2396df7b.js"><link rel="prefetch" href="/assets/js/165.06ddad7b.js"><link rel="prefetch" href="/assets/js/166.5d57a2ae.js"><link rel="prefetch" href="/assets/js/167.e8b4fff3.js"><link rel="prefetch" href="/assets/js/168.62196862.js"><link rel="prefetch" href="/assets/js/169.3cdfedc2.js"><link rel="prefetch" href="/assets/js/17.9c36003c.js"><link rel="prefetch" href="/assets/js/170.e934931c.js"><link rel="prefetch" href="/assets/js/171.d297efee.js"><link rel="prefetch" href="/assets/js/172.a4e28e04.js"><link rel="prefetch" href="/assets/js/173.1ba4f3f6.js"><link rel="prefetch" href="/assets/js/174.127a335b.js"><link rel="prefetch" href="/assets/js/175.994c8e8a.js"><link rel="prefetch" href="/assets/js/176.f98347de.js"><link rel="prefetch" href="/assets/js/177.487fc3b1.js"><link rel="prefetch" href="/assets/js/178.d036fcf6.js"><link rel="prefetch" href="/assets/js/179.40c33b19.js"><link rel="prefetch" href="/assets/js/18.506400f8.js"><link rel="prefetch" href="/assets/js/180.a75ef971.js"><link rel="prefetch" href="/assets/js/181.010b5e78.js"><link rel="prefetch" href="/assets/js/182.810851bf.js"><link rel="prefetch" href="/assets/js/183.702bebf5.js"><link rel="prefetch" href="/assets/js/184.f41549d7.js"><link rel="prefetch" href="/assets/js/185.683f0e9b.js"><link rel="prefetch" href="/assets/js/186.d874f52e.js"><link rel="prefetch" href="/assets/js/187.135f3291.js"><link rel="prefetch" href="/assets/js/188.e7bef446.js"><link rel="prefetch" href="/assets/js/189.818e4606.js"><link rel="prefetch" href="/assets/js/19.9fb03cba.js"><link rel="prefetch" href="/assets/js/190.077cba82.js"><link rel="prefetch" href="/assets/js/191.42cb23a5.js"><link rel="prefetch" href="/assets/js/192.4441e558.js"><link rel="prefetch" href="/assets/js/193.7ffe1971.js"><link rel="prefetch" href="/assets/js/194.3f8a868f.js"><link rel="prefetch" href="/assets/js/195.d744e031.js"><link rel="prefetch" href="/assets/js/196.4f1d4998.js"><link rel="prefetch" href="/assets/js/197.ed4f1218.js"><link rel="prefetch" href="/assets/js/198.9e79d6bb.js"><link rel="prefetch" href="/assets/js/199.6cb76d2c.js"><link rel="prefetch" href="/assets/js/20.37c2fab7.js"><link rel="prefetch" href="/assets/js/200.8df394da.js"><link rel="prefetch" href="/assets/js/201.ce8b0ead.js"><link rel="prefetch" href="/assets/js/202.2a1a64cf.js"><link rel="prefetch" href="/assets/js/203.67716e41.js"><link rel="prefetch" href="/assets/js/204.ff0eb787.js"><link rel="prefetch" href="/assets/js/205.45124eb4.js"><link rel="prefetch" href="/assets/js/206.ee2d8668.js"><link rel="prefetch" href="/assets/js/207.cb31d363.js"><link rel="prefetch" href="/assets/js/208.dd1fb63f.js"><link rel="prefetch" href="/assets/js/209.9925727e.js"><link rel="prefetch" href="/assets/js/21.31d17ce2.js"><link rel="prefetch" href="/assets/js/210.71f0902c.js"><link rel="prefetch" href="/assets/js/211.4e6f850d.js"><link rel="prefetch" href="/assets/js/212.26055c34.js"><link rel="prefetch" href="/assets/js/213.d5637bff.js"><link rel="prefetch" href="/assets/js/214.3941afba.js"><link rel="prefetch" href="/assets/js/215.629e6a05.js"><link rel="prefetch" href="/assets/js/216.58253aa8.js"><link rel="prefetch" href="/assets/js/217.b3f49c47.js"><link rel="prefetch" href="/assets/js/218.eb21704a.js"><link rel="prefetch" href="/assets/js/219.36ae6c18.js"><link rel="prefetch" href="/assets/js/22.89b19df6.js"><link rel="prefetch" href="/assets/js/220.f9d63e81.js"><link rel="prefetch" href="/assets/js/221.a3be1764.js"><link rel="prefetch" href="/assets/js/222.6ae207ea.js"><link rel="prefetch" href="/assets/js/223.db9318d4.js"><link rel="prefetch" href="/assets/js/224.1e8218be.js"><link rel="prefetch" href="/assets/js/225.5b7dba01.js"><link rel="prefetch" href="/assets/js/226.a22e57e8.js"><link rel="prefetch" href="/assets/js/227.f1005c9e.js"><link rel="prefetch" href="/assets/js/228.2b2c955a.js"><link rel="prefetch" href="/assets/js/229.2f08c5d4.js"><link rel="prefetch" href="/assets/js/23.d921d0f1.js"><link rel="prefetch" href="/assets/js/230.5b309e8c.js"><link rel="prefetch" href="/assets/js/231.d33c3d69.js"><link rel="prefetch" href="/assets/js/232.97008541.js"><link rel="prefetch" href="/assets/js/233.7e55aaa8.js"><link rel="prefetch" href="/assets/js/234.f965a7b9.js"><link rel="prefetch" href="/assets/js/235.3dc15bb7.js"><link rel="prefetch" href="/assets/js/236.08387962.js"><link rel="prefetch" href="/assets/js/237.7d06e54f.js"><link rel="prefetch" href="/assets/js/238.80b3c4ed.js"><link rel="prefetch" href="/assets/js/239.2d3582ae.js"><link rel="prefetch" href="/assets/js/24.75e62eb6.js"><link rel="prefetch" href="/assets/js/240.4901f8b5.js"><link rel="prefetch" href="/assets/js/241.15df725b.js"><link rel="prefetch" href="/assets/js/242.88fc364c.js"><link rel="prefetch" href="/assets/js/243.efd97d01.js"><link rel="prefetch" href="/assets/js/244.bf36b3eb.js"><link rel="prefetch" href="/assets/js/245.0654ebdb.js"><link rel="prefetch" href="/assets/js/246.6bb77e74.js"><link rel="prefetch" href="/assets/js/247.d55d05fe.js"><link rel="prefetch" href="/assets/js/248.e8ef6294.js"><link rel="prefetch" href="/assets/js/249.9a0d8c28.js"><link rel="prefetch" href="/assets/js/25.242775bb.js"><link rel="prefetch" href="/assets/js/250.918b8cc4.js"><link rel="prefetch" href="/assets/js/251.062cba45.js"><link rel="prefetch" href="/assets/js/252.b666ed8d.js"><link rel="prefetch" href="/assets/js/253.c373c75a.js"><link rel="prefetch" href="/assets/js/254.50730a46.js"><link rel="prefetch" href="/assets/js/255.6cdb294d.js"><link rel="prefetch" href="/assets/js/256.934d7cb9.js"><link rel="prefetch" href="/assets/js/257.738eedf0.js"><link rel="prefetch" href="/assets/js/258.f14aeab6.js"><link rel="prefetch" href="/assets/js/259.b178910b.js"><link rel="prefetch" href="/assets/js/26.3e900670.js"><link rel="prefetch" href="/assets/js/260.f99fb7d9.js"><link rel="prefetch" href="/assets/js/261.947df75f.js"><link rel="prefetch" href="/assets/js/262.d8948a38.js"><link rel="prefetch" href="/assets/js/263.a99c800f.js"><link rel="prefetch" href="/assets/js/264.6702ae55.js"><link rel="prefetch" href="/assets/js/265.766b5874.js"><link rel="prefetch" href="/assets/js/266.06ff3d0c.js"><link rel="prefetch" href="/assets/js/267.d5355fb2.js"><link rel="prefetch" href="/assets/js/268.e1503b2b.js"><link rel="prefetch" href="/assets/js/269.595cdc86.js"><link rel="prefetch" href="/assets/js/27.f7e09b52.js"><link rel="prefetch" href="/assets/js/270.f28be471.js"><link rel="prefetch" href="/assets/js/271.be976ea7.js"><link rel="prefetch" href="/assets/js/272.e9a81e46.js"><link rel="prefetch" href="/assets/js/273.692b1d49.js"><link rel="prefetch" href="/assets/js/274.a34754e0.js"><link rel="prefetch" href="/assets/js/275.6efd1a78.js"><link rel="prefetch" href="/assets/js/276.6392be95.js"><link rel="prefetch" href="/assets/js/277.415478a3.js"><link rel="prefetch" href="/assets/js/278.8b669536.js"><link rel="prefetch" href="/assets/js/279.28316330.js"><link rel="prefetch" href="/assets/js/28.4ea0d525.js"><link rel="prefetch" href="/assets/js/280.d6a40b3a.js"><link rel="prefetch" href="/assets/js/281.8897f5e9.js"><link rel="prefetch" href="/assets/js/282.a7e0c798.js"><link rel="prefetch" href="/assets/js/283.997ba6a7.js"><link rel="prefetch" href="/assets/js/284.6cb69240.js"><link rel="prefetch" href="/assets/js/285.aed7d04a.js"><link rel="prefetch" href="/assets/js/286.0309f626.js"><link rel="prefetch" href="/assets/js/287.d5e38cc8.js"><link rel="prefetch" href="/assets/js/288.afcc5533.js"><link rel="prefetch" href="/assets/js/289.1116a1aa.js"><link rel="prefetch" href="/assets/js/29.28aa1e30.js"><link rel="prefetch" href="/assets/js/3.9f6c2b9a.js"><link rel="prefetch" href="/assets/js/30.f1099f25.js"><link rel="prefetch" href="/assets/js/31.090b2fdf.js"><link rel="prefetch" href="/assets/js/32.2cf9a311.js"><link rel="prefetch" href="/assets/js/33.c4a6666c.js"><link rel="prefetch" href="/assets/js/34.bcd441d7.js"><link rel="prefetch" href="/assets/js/35.f01b78c3.js"><link rel="prefetch" href="/assets/js/36.730fe078.js"><link rel="prefetch" href="/assets/js/37.fa7d560d.js"><link rel="prefetch" href="/assets/js/38.aeed869b.js"><link rel="prefetch" href="/assets/js/39.857bd2e9.js"><link rel="prefetch" href="/assets/js/4.59be05da.js"><link rel="prefetch" href="/assets/js/40.c7de774e.js"><link rel="prefetch" href="/assets/js/41.245c912c.js"><link rel="prefetch" href="/assets/js/42.b70d04ef.js"><link rel="prefetch" href="/assets/js/43.715843c6.js"><link rel="prefetch" href="/assets/js/44.05ac1457.js"><link rel="prefetch" href="/assets/js/45.255694cc.js"><link rel="prefetch" href="/assets/js/46.5d943476.js"><link rel="prefetch" href="/assets/js/47.c3931225.js"><link rel="prefetch" href="/assets/js/48.cea486a6.js"><link rel="prefetch" href="/assets/js/49.831356bb.js"><link rel="prefetch" href="/assets/js/5.9e722933.js"><link rel="prefetch" href="/assets/js/50.c88d3ae6.js"><link rel="prefetch" href="/assets/js/51.25210dbe.js"><link rel="prefetch" href="/assets/js/52.8662b572.js"><link rel="prefetch" href="/assets/js/53.b15c5ebe.js"><link rel="prefetch" href="/assets/js/54.76cdcfee.js"><link rel="prefetch" href="/assets/js/55.d048747b.js"><link rel="prefetch" href="/assets/js/56.53ad3600.js"><link rel="prefetch" href="/assets/js/57.0840c820.js"><link rel="prefetch" href="/assets/js/58.8456ec43.js"><link rel="prefetch" href="/assets/js/59.248071fd.js"><link rel="prefetch" href="/assets/js/6.e5fc690c.js"><link rel="prefetch" href="/assets/js/60.6f161fef.js"><link rel="prefetch" href="/assets/js/61.0436c50f.js"><link rel="prefetch" href="/assets/js/62.ca707c81.js"><link rel="prefetch" href="/assets/js/63.ece29c74.js"><link rel="prefetch" href="/assets/js/64.e6a9f94b.js"><link rel="prefetch" href="/assets/js/65.f1d5f560.js"><link rel="prefetch" href="/assets/js/66.4629bac2.js"><link rel="prefetch" href="/assets/js/67.ce0329a4.js"><link rel="prefetch" href="/assets/js/68.a1351344.js"><link rel="prefetch" href="/assets/js/69.64674d5d.js"><link rel="prefetch" href="/assets/js/7.2daa8971.js"><link rel="prefetch" href="/assets/js/70.999a9930.js"><link rel="prefetch" href="/assets/js/71.a1193652.js"><link rel="prefetch" href="/assets/js/72.b44533d9.js"><link rel="prefetch" href="/assets/js/73.a79847d8.js"><link rel="prefetch" href="/assets/js/74.e2d6ac74.js"><link rel="prefetch" href="/assets/js/75.da107ce4.js"><link rel="prefetch" href="/assets/js/76.6dfe7bba.js"><link rel="prefetch" href="/assets/js/77.1323db38.js"><link rel="prefetch" href="/assets/js/78.3d05b55b.js"><link rel="prefetch" href="/assets/js/79.b00891aa.js"><link rel="prefetch" href="/assets/js/8.2f482571.js"><link rel="prefetch" href="/assets/js/80.4e9d8208.js"><link rel="prefetch" href="/assets/js/81.6e05b237.js"><link rel="prefetch" href="/assets/js/82.bc9f7430.js"><link rel="prefetch" href="/assets/js/83.595d571f.js"><link rel="prefetch" href="/assets/js/84.06df0a50.js"><link rel="prefetch" href="/assets/js/85.c352765f.js"><link rel="prefetch" href="/assets/js/86.e795a2ac.js"><link rel="prefetch" href="/assets/js/87.242d136b.js"><link rel="prefetch" href="/assets/js/88.2271fece.js"><link rel="prefetch" href="/assets/js/89.5febaab9.js"><link rel="prefetch" href="/assets/js/9.76b7e3a6.js"><link rel="prefetch" href="/assets/js/90.a67f5f29.js"><link rel="prefetch" href="/assets/js/91.3f32dc0b.js"><link rel="prefetch" href="/assets/js/92.0335222f.js"><link rel="prefetch" href="/assets/js/93.8731ce80.js"><link rel="prefetch" href="/assets/js/94.8c98caaa.js"><link rel="prefetch" href="/assets/js/96.15e1b410.js"><link rel="prefetch" href="/assets/js/97.e2d2521b.js"><link rel="prefetch" href="/assets/js/98.0b432757.js"><link rel="prefetch" href="/assets/js/99.bdc7b846.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7055dd22.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="TQK的个人博客" class="logo"> <span class="site-name can-hide">TQK的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="入门基础" class="dropdown-title"><span class="title">入门基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="入门基础" class="mobile-dropdown-title"><span class="title">入门基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/java/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/base/seniorJava/" class="nav-link">
  Java基础(高级)
</a></li><li class="dropdown-item"><!----> <a href="/base/data-structure/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/base/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/base/JVM/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/base/es6/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/base/shell/" class="nav-link">
  Shell脚本
</a></li><li class="dropdown-item"><!----> <a href="/base/golang/" class="nav-link">
  go语言
</a></li><li class="dropdown-item"><!----> <a href="/base/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/base/c/" class="nav-link">
  C语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/db/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/db/mongdb/" class="nav-link">
  Mongdb
</a></li><li class="dropdown-item"><!----> <a href="/db/oracle/" class="nav-link">
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="/db/fenkufenbiao/" class="nav-link router-link-active">
  分库分表
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/framework/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/framework/springboot/" class="nav-link">
  Springboot
</a></li><li class="dropdown-item"><!----> <a href="/framework/dubbo/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/framework/vue/" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          SpringCloud
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/SpringCloud/Eureka/" class="nav-link">
  Eureka
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Consul/" class="nav-link">
  Consul
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Feign/" class="nav-link">
  Feign
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Hystrix/" class="nav-link">
  Hystrix
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/zuul/" class="nav-link">
  Zuul
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/gateway/" class="nav-link">
  Gateway
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/sleuth/" class="nav-link">
  Sleuth链路追踪
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Apollo/" class="nav-link">
  Apollo配置中心
</a></li></ul></li><li class="dropdown-item"><h4>
          SpringCloudAlibaba
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/nacos/" class="nav-link">
  Nacos
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/Sentinel/" class="nav-link">
  Sentinel
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/seata/" class="nav-link">
  seata
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/netty/" class="nav-link">
  netty
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zookeeper/" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/middleware/sso/" class="nav-link">
  单点登陆
</a></li><li class="dropdown-item"><!----> <a href="/middleware/Elasticsearch/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><h4>
          MQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/middleware/RabbitMQ/" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-subitem"><a href="/middleware/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-subitem"><a href="/middleware/RocketMQ/" class="nav-link">
  RocketMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云原生" class="dropdown-title"><span class="title">云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="云原生" class="mobile-dropdown-title"><span class="title">云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/network/" class="nav-link">
  云原生网络
</a></li><li class="dropdown-item"><!----> <a href="/middleware/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/middleware/kubernetes/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/tool/Jenkins/" class="nav-link">
  Jenkins
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/alibaba/" class="nav-link">
  阿里巴巴Java开发手册
</a></li><li class="dropdown-item"><!----> <a href="/other/english/" class="nav-link">
  编程英语
</a></li><li class="dropdown-item"><!----> <a href="/other/idea/" class="nav-link">
  IDEA快捷键
</a></li><li class="dropdown-item"><!----> <a href="/other/url/" class="nav-link">
  常用网站
</a></li><li class="dropdown-item"><!----> <a href="/other/jdk/" class="nav-link">
  Liunx安装jdk
</a></li><li class="dropdown-item"><!----> <a href="/other/VMware/" class="nav-link">
  VMware
</a></li><li class="dropdown-item"><!----> <a href="/other/jiqun/" class="nav-link">
  Liunx集群
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/jemeter/" class="nav-link">
  jemeter
</a></li><li class="dropdown-item"><!----> <a href="/tool/postman/" class="nav-link">
  postman
</a></li><li class="dropdown-item"><!----> <a href="/tool/PowerDesigner/" class="nav-link">
  PowerDesigner
</a></li><li class="dropdown-item"><!----> <a href="/tool/Nodejs/" class="nav-link">
  Nodejs
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tianqikai/blogvuepress" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="入门基础" class="dropdown-title"><span class="title">入门基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="入门基础" class="mobile-dropdown-title"><span class="title">入门基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/java/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/base/seniorJava/" class="nav-link">
  Java基础(高级)
</a></li><li class="dropdown-item"><!----> <a href="/base/data-structure/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/base/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/base/JVM/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/base/es6/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/base/shell/" class="nav-link">
  Shell脚本
</a></li><li class="dropdown-item"><!----> <a href="/base/golang/" class="nav-link">
  go语言
</a></li><li class="dropdown-item"><!----> <a href="/base/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/base/c/" class="nav-link">
  C语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/db/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/db/mongdb/" class="nav-link">
  Mongdb
</a></li><li class="dropdown-item"><!----> <a href="/db/oracle/" class="nav-link">
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="/db/fenkufenbiao/" class="nav-link router-link-active">
  分库分表
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/framework/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/framework/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/framework/springboot/" class="nav-link">
  Springboot
</a></li><li class="dropdown-item"><!----> <a href="/framework/dubbo/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/framework/vue/" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          SpringCloud
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/SpringCloud/Eureka/" class="nav-link">
  Eureka
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Consul/" class="nav-link">
  Consul
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Feign/" class="nav-link">
  Feign
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Hystrix/" class="nav-link">
  Hystrix
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/zuul/" class="nav-link">
  Zuul
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/gateway/" class="nav-link">
  Gateway
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/sleuth/" class="nav-link">
  Sleuth链路追踪
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloud/Apollo/" class="nav-link">
  Apollo配置中心
</a></li></ul></li><li class="dropdown-item"><h4>
          SpringCloudAlibaba
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/nacos/" class="nav-link">
  Nacos
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/Sentinel/" class="nav-link">
  Sentinel
</a></li><li class="dropdown-subitem"><a href="/framework/SpringCloudAlibaba/seata/" class="nav-link">
  seata
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/netty/" class="nav-link">
  netty
</a></li><li class="dropdown-item"><!----> <a href="/middleware/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/middleware/zookeeper/" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/middleware/sso/" class="nav-link">
  单点登陆
</a></li><li class="dropdown-item"><!----> <a href="/middleware/Elasticsearch/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><h4>
          MQ
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/middleware/RabbitMQ/" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-subitem"><a href="/middleware/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-subitem"><a href="/middleware/RocketMQ/" class="nav-link">
  RocketMQ
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云原生" class="dropdown-title"><span class="title">云原生</span> <span class="arrow down"></span></button> <button type="button" aria-label="云原生" class="mobile-dropdown-title"><span class="title">云原生</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/network/" class="nav-link">
  云原生网络
</a></li><li class="dropdown-item"><!----> <a href="/middleware/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/middleware/kubernetes/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/tool/Jenkins/" class="nav-link">
  Jenkins
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/alibaba/" class="nav-link">
  阿里巴巴Java开发手册
</a></li><li class="dropdown-item"><!----> <a href="/other/english/" class="nav-link">
  编程英语
</a></li><li class="dropdown-item"><!----> <a href="/other/idea/" class="nav-link">
  IDEA快捷键
</a></li><li class="dropdown-item"><!----> <a href="/other/url/" class="nav-link">
  常用网站
</a></li><li class="dropdown-item"><!----> <a href="/other/jdk/" class="nav-link">
  Liunx安装jdk
</a></li><li class="dropdown-item"><!----> <a href="/other/VMware/" class="nav-link">
  VMware
</a></li><li class="dropdown-item"><!----> <a href="/other/jiqun/" class="nav-link">
  Liunx集群
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/maven/" class="nav-link">
  maven
</a></li><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/jemeter/" class="nav-link">
  jemeter
</a></li><li class="dropdown-item"><!----> <a href="/tool/postman/" class="nav-link">
  postman
</a></li><li class="dropdown-item"><!----> <a href="/tool/PowerDesigner/" class="nav-link">
  PowerDesigner
</a></li><li class="dropdown-item"><!----> <a href="/tool/Nodejs/" class="nav-link">
  Nodejs
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tianqikai/blogvuepress" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Fenkufenbiao</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/fenkufenbiao/" aria-current="page" class="sidebar-link">MYSQL分库分表</a></li><li><a href="/db/fenkufenbiao/Mysql分表分库简介-0.html" class="sidebar-link">1. Mysql分表分库简介</a></li><li><a href="/db/fenkufenbiao/Mysql主从集群搭建-1.html" class="sidebar-link">2. Mysql搭建主从集群</a></li><li><a href="/db/fenkufenbiao/MySQL的高可用方案-2.html" class="sidebar-link">3. MySQL的高可用方案</a></li><li><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html" class="active sidebar-link">4. ShardingJDBC实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-1-核心概念" class="sidebar-link">4.1 核心概念</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-shardingjdbc的分片算法" class="sidebar-link">4.2 ShardingJDBC的分片算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-1-noneshardingstrategy" class="sidebar-link">4.2.1 NoneShardingStrategy</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-2-inlineshardingstrategy" class="sidebar-link">4.2.2 InlineShardingStrategy</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-3-standardshardingstrategy" class="sidebar-link">4.2.3 StandardShardingStrategy</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-4-complexshardingstrategy" class="sidebar-link">4.2.4 ComplexShardingStrategy</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-2-5-hintshardingstrategy" class="sidebar-link">4.2.5 HintShardingStrategy</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-3-shardingsphere的sql使用限制" class="sidebar-link">4.3 ShardingSphere的SQL使用限制</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-4-快速实战-分表" class="sidebar-link">4.4 快速实战-分表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-4-1-application-properties" class="sidebar-link">4.4.1 application.properties</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-4-2-测试案例" class="sidebar-link">4.4.2  测试案例</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-4-3-测试结果" class="sidebar-link">4.4.3 测试结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-5-快速实战-inline" class="sidebar-link">4.5 快速实战-inline</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-5-1-简单分库策略配置" class="sidebar-link">4.5.1 简单分库策略配置</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-5-2-测试案例" class="sidebar-link">4.5.2  测试案例</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-5-3-测试结果" class="sidebar-link">4.5.3 测试结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-6-快速实战-standard" class="sidebar-link">4.6 快速实战-standard</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-6-1-配置文件" class="sidebar-link">4.6.1 配置文件</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-6-2-自定义分片策略" class="sidebar-link">4.6.2 自定义分片策略</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-6-3-测试" class="sidebar-link">4.6.3 测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-快速实战-complex-复杂分片策略" class="sidebar-link">4.7 快速实战-complex--复杂分片策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-1-配置文件" class="sidebar-link">4.7.1 配置文件</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-2-自定义分片策略" class="sidebar-link">4.7.2 自定义分片策略</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-3-测试" class="sidebar-link">4.7.3 测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-8-快速实战-hint强制路由策略" class="sidebar-link">4.8 快速实战-hint强制路由策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-8-1-配置文件" class="sidebar-link">4.8.1 配置文件</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-2-自定义分片策略-2" class="sidebar-link">4.7.2 自定义分片策略</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-7-3-测试-2" class="sidebar-link">4.7.3 测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-9-广播表" class="sidebar-link">4.9 广播表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-9-1-配置信息" class="sidebar-link">4.9.1 配置信息</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-9-2-测试" class="sidebar-link">4.9.2 测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-10-绑定表" class="sidebar-link">4.10 绑定表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-10-1-配置信息" class="sidebar-link">4.10.1 配置信息</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-10-2-测试类" class="sidebar-link">4.10.2 测试类</a></li></ul></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-11-读写分离" class="sidebar-link">4.11 读写分离</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-11-1-配置信息" class="sidebar-link">4.11.1 配置信息</a></li><li class="sidebar-sub-header"><a href="/db/fenkufenbiao/ShardingJDBC实战-3.html#_4-11-2-测试类" class="sidebar-link">4.11.2 测试类</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-shardingjdbc实战"><a href="#_4-shardingjdbc实战" class="header-anchor">#</a> 4. ShardingJDBC实战</h1> <h2 id="_4-1-核心概念"><a href="#_4-1-核心概念" class="header-anchor">#</a> 4.1 核心概念</h2> <ol><li><strong>逻辑表</strong>：水平拆分的数据库的相同逻辑和数据结构表的总称</li> <li><strong>真实表</strong>：在分片的数据库中真实存在的物理表。</li> <li><strong>数据节点</strong>：数据分片的最小单元。由数据源名称和数据表组成</li> <li><strong>绑定表</strong>：分片规则一致的主表和子表。</li> <li><strong>广播表</strong>：也叫公共表，指素有的分片数据源中都存在的表，表结构和表中的数据在每个数据库中都完全一致。例如字典表。</li> <li><strong>分片键</strong>：用于分片的数据库字段，是将数据库(表)进行水平拆分的关键字段。SQL中若没有分片字段，将会执行全路由，性能会很差。</li> <li><strong>分片算法</strong>：通过分片算法将数据进行分片，支持通过=、BETWEEN和IN分片。分片算法需要由应用开发者自行实现，可实现的灵活度非常高。</li> <li><strong>分片策略</strong>：真正用于进行分片操作的是分片键+分片算法，也就是分片策略。在ShardingJDBC中一般采用基于Groovy表达式的inline分片策略，通过一个包含
分片键的算法表达式来制定分片策略，如t_user_$-&gt;{u_id%8}标识根据u_id模8，分成8张表，表名称为t_user_0到t_user_7。</li></ol> <h2 id="_4-2-shardingjdbc的分片算法"><a href="#_4-2-shardingjdbc的分片算法" class="header-anchor">#</a> 4.2 ShardingJDBC的分片算法</h2> <p>ShardingJDBC的整个实战完成后，可以看到，整个分库分表的核心就是在于配置的分片算法。</p> <p>我们的这些实战都是使用的inline分片算法，即提供一个分片键和一个分片表达式来制定分片算法。这种方式配置简单，功能灵活，是分库分表最佳的配置方式，并且对于绝大多数的分库分片场景来说，都已经非常好用了</p> <p>但是如果<strong>针对一些更为复杂的分片策略，例如多分片键、按范围分片等场景</strong>，inline分片算法就有点力不从心了。所以我们还需要学习下ShardingSphere提供的其他几种分片策略</p> <h3 id="_4-2-1-noneshardingstrategy"><a href="#_4-2-1-noneshardingstrategy" class="header-anchor">#</a> 4.2.1 NoneShardingStrategy</h3> <p>不分片。这种严格来说不算是一种分片策略了。只是ShardingSphere也提供了这么一个配置</p> <h3 id="_4-2-2-inlineshardingstrategy"><a href="#_4-2-2-inlineshardingstrategy" class="header-anchor">#</a> 4.2.2 InlineShardingStrategy</h3> <p><strong>最常用的分片方式</strong></p> <p><strong>配置参数</strong>： inline.shardingColumn 分片键；inline.algorithmExpression分片表达式</p> <p><strong>实现方式</strong>： 按照分片表达式来进行分片。</p> <h3 id="_4-2-3-standardshardingstrategy"><a href="#_4-2-3-standardshardingstrategy" class="header-anchor">#</a> 4.2.3 StandardShardingStrategy</h3> <p>只支持单分片键的标准分片策略</p> <div class="custom-block tip"><p class="custom-block-title">配置参数</p> <ol><li><p>standard.sharding-column 分片键；</p></li> <li><p>standard.precise-algorithm-class-name 精确分片算法类名；</p></li> <li><p>standard.range-algorithm-class-name 范围分片算法类名</p></li></ol></div> <hr> <div class="custom-block tip"><p class="custom-block-title">实现方式</p> <ol><li><p>shardingColumn指定分片算法。</p></li> <li><p>preciseAlgorithmClassName 指向一个实现了
io.shardingsphere.api.algorithm.sharding.standard.PreciseShardingAl</p></li> <li><p>gorithm接口的java类名，提供按照 = 或者 IN 逻辑的精确分片
示例：
com.roy.shardingDemo.algorithm.MyPreciseShardingAlgorithm</p></li> <li><p>rangeAlgorithmClassName 指向一个实现了
io.shardingsphere.api.algorithm.sharding.standard.RangeShardingAlg</p></li> <li><p>orithm接口的java类名，提供按照Between 条件进行的范围分片。
示例：
com.roy.shardingDemo.algorithm.MyRangeShardingAlgorithm</p></li></ol></div> <p><strong>说明</strong>：<br>
其中<strong>精确分片算法是必须提供的</strong>，而范围分片算法则是可选的。</p> <h3 id="_4-2-4-complexshardingstrategy"><a href="#_4-2-4-complexshardingstrategy" class="header-anchor">#</a> 4.2.4 ComplexShardingStrategy</h3> <p><strong>支持多分片键的复杂分片策略</strong></p> <div class="custom-block tip"><p class="custom-block-title">配置参数：</p> <ol><li>complex.sharding-columns 分片键(多个);</li> <li>complex.algorithm-class-name 分片算法实现类。</li></ol></div> <div class="custom-block tip"><p class="custom-block-title">实现方式：</p> <ol><li><p>shardingColumn指定多个分片列。</p></li> <li><p>algorithmClassName指向一个实现了org.apache.shardingsphere.api.sharding.complex.ComplexKeysShardi</p></li> <li><p>ngAlgorithm接口的java类名。提供按照多个分片列进行综合分片的算法。</p></li></ol></div> <p><strong>示例：</strong>
com.roy.shardingDemo.algorithm.MyComplexKeysShardingAlgorithm</p> <hr> <h3 id="_4-2-5-hintshardingstrategy"><a href="#_4-2-5-hintshardingstrategy" class="header-anchor">#</a> 4.2.5 HintShardingStrategy</h3> <p>不需要分片键的强制分片策略。这个分片策略，简单来理解就是说，他的分片键
不再跟SQL语句相关联，而是用程序另行指定。对于一些复杂的情况，例如
select count(*) from (select userid from t_user where userid in (1,3,5,7,9))
这样的SQL语句，就没法通过SQL语句来指定一个分片键。这个时候就可以通过
程序，给他另行执行一个分片键，例如在按userid奇偶分片的策略下，可以指定
1作为分片键，然后自行指定他的分片策略。</p> <div class="custom-block tip"><p class="custom-block-title">配置参数：</p> <p>hint.algorithm-class-name 分片算法实现类。</p></div> <div class="custom-block tip"><p class="custom-block-title">实现方式：</p> <ol><li><p>algorithmClassName指向一个实现了org.apache.shardingsphere.api.sharding.hint.HintShardingAlgorithm接口的java类名。 示例：com.roy.shardingDemo.algorithm.MyHintShardingAlgorithm</p></li> <li><p>在这个算法类中，同样是需要分片键的。而分片键的指定是通过
HintManager.addDatabaseShardingValue方法(分库)和
HintManager.addTableShardingValue(分表)来指定。</p></li> <li><p>使用时要注意，这个分片键是线程隔离的，只在当前线程有效，所以通常建
议使用之后立即关闭，或者用try资源方式打开。</p></li> <li><p>而Hint分片策略并没有完全按照SQL解析树来构建分片策略，是绕开
了SQL解析的，所有对某些比较复杂的语句，Hint分片策略性能有可
能会比较好(情况太多了，无法一一分析)。</p></li></ol></div> <p>但是要注意，Hint强制路由在使用时有非常多的限制：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 不支持UNION </span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_order1 <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_order2 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_name <span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">,</span> …<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> col1<span class="token punctuation">,</span> col2<span class="token punctuation">,</span> … <span class="token keyword">FROM</span> tbl_name <span class="token keyword">WHERE</span> col3 <span class="token operator">=</span> ? 
<span class="token comment">-- 不支持多层子查询 </span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_order o <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> t_order <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> ?<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment">-- 不支持函数计算。ShardingSphere只能通过SQL字面提取用于分片的值 </span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_order <span class="token keyword">WHERE</span> to_date<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span> <span class="token string">'yyyy-mm-dd'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'2019-01-01'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_4-3-shardingsphere的sql使用限制"><a href="#_4-3-shardingsphere的sql使用限制" class="header-anchor">#</a> 4.3 ShardingSphere的SQL使用限制</h2> <p>参见官网文档: [https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/sql/]</p> <p>文档中详细列出了非常多ShardingSphere目前版本支持和不支持的SQL类型。这些东西要经常关注。</p> <h2 id="_4-4-快速实战-分表"><a href="#_4-4-快速实战-分表" class="header-anchor">#</a> 4.4 快速实战-分表</h2> <h3 id="_4-4-1-application-properties"><a href="#_4-4-1-application-properties" class="header-anchor">#</a> 4.4.1 application.properties</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#垂直分表策略</span>
<span class="token comment">#配置真实数据源</span>
<span class="token attr-name">spring.shardingsphere.datasource.names</span><span class="token punctuation">=</span><span class="token attr-value">m1</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># serverTimezone=GMT%2B8 数据库查询时间问题</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3310/tqktest777?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>

<span class="token comment">#配置真实表分布</span>
<span class="token comment"># 指定表的分布情况 配置表在哪个数据库里，表名是什么。水平分表，分两个表： m1.course_1,m1.course_2</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">m1.course_$-&gt;{1..2}</span>
<span class="token comment">#主键生成策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>

<span class="token comment">#雪花算法</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
<span class="token comment">#雪花算法的一个可选参数</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>

<span class="token comment">#配置分表策略</span>
<span class="token comment"># 选定计算的字段</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token comment">#指定分片策略 约定cid值为偶数添加到course_1表。如果是奇数添加到course_2表。</span>
<span class="token comment"># 根据计算的字段算出对应的表名。</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">course_$-&gt;{cid%2+1}</span>

<span class="token comment">#其他运行属性</span>
<span class="token comment"># 打开sql日志输出。</span>
<span class="token attr-name">spring.shardingsphere.props.sql.show</span> <span class="token punctuation">=</span> <span class="token attr-value">true</span>
<span class="token attr-name">spring.main.allow-bean-definition-overriding</span><span class="token punctuation">=</span><span class="token attr-value">true</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ol><li><p>首先定义一个数据源m1，并对m1进行实际的JDBC参数配置</p></li> <li><p>spring.shardingsphere.sharding.tables.course开头的一系列属性即定义了一个名为<strong>course的逻辑表</strong>。</p></li> <li><p><strong>actual-data-nodes属性即定义course逻辑表的实际数据分布情况</strong>，他分布在m1.course_1和m1.course_2两个表。</p></li> <li><p><strong>key-generator</strong>属性配置了他的主键列以及主键生成策略。</p></li> <li><p>ShardingJDBC默认提供了UUID和SNOWFLAKE两种分布式主键生成策略。</p></li> <li><p><strong>table-strategy属性即配置他的分库分表策略</strong>。分片键为cid属性。分片算法为course_$-&gt;{cid%2+1}，表示按照cid模2+1的结果，然后加上前面的course__ 部分作为前缀就是他的实际表结果。</p></li></ol> <p><strong>注意：</strong> 这个表达式计算出来的结果需要能够与实际数据分布中的一种情况对应上，否则就会报错。</p> <ol start="7"><li><strong>sql.show</strong>属性表示要在日志中打印实际SQL</li></ol> <h3 id="_4-4-2-测试案例"><a href="#_4-4-2-测试案例" class="header-anchor">#</a> 4.4.2  测试案例</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJDBCTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">CourseMapper</span> courseMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 取模分片策略
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Course</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Course</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            c.setCid(Long.valueOf(i));</span>
            c<span class="token punctuation">.</span><span class="token function">setCname</span><span class="token punctuation">(</span><span class="token string">&quot;shardingsphere&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">setCstatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            courseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_4-4-3-测试结果"><a href="#_4-4-3-测试结果" class="header-anchor">#</a> 4.4.3 测试结果</h3> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 09:17:28.267  INFO 34764 --- [           main] ShardingSphere-SQL                       : SQLStatement: InsertStatementContext(super=CommonSQLStatementContext(sqlStatement=org.apache.shardingsphere.sql.parser.sql.statement.dml.InsertStatement@3c19592c, tablesContext=org.apache.shardingsphere.sql.parser.binder.segment.table.TablesContext@413d2cd1), tablesContext=org.apache.shardingsphere.sql.parser.binder.segment.table.TablesContext@413d2cd1, columnNames=[cname, user_id, cstatus], insertValueContexts=[InsertValueContext(parametersCount=3, valueExpressions=[ParameterMarkerExpressionSegment(startIndex=59, stopIndex=59, parameterMarkerIndex=0), ParameterMarkerExpressionSegment(startIndex=62, stopIndex=62, parameterMarkerIndex=1), ParameterMarkerExpressionSegment(startIndex=65, stopIndex=65, parameterMarkerIndex=2), DerivedParameterMarkerExpressionSegment(super=ParameterMarkerExpressionSegment(startIndex=0, stopIndex=0, parameterMarkerIndex=3))], parameters=[shardingsphere, 1008, 1])], generatedKeyContext=Optional[GeneratedKeyContext(columnName=cid, generated=true, generatedValues=[675993661539880960])])
2021-12-10 09:17:28.267  INFO 34764 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: INSERT INTO course_1  ( cname,
user_id,
cstatus , cid)  VALUES  (?, ?, ?, ?) ::: [shardingsphere, 1008, 1, 675993661539880960]
2021-12-10 09:17:28.352  INFO 34764 --- [           main] ShardingSphere-SQL                       : Logic SQL: INSERT INTO course  ( cname,
user_id,
cstatus )  VALUES  ( ?,
?,
? )
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>从这个日志中我们可以看到，程序中执行的Logic SQL经过ShardingJDBC处理后，被转换成了Actual SQL往数据库里执行。执行的结果可以在MySQL中看到，
course_1和course_2两个表中各插入了五条消息。这就是ShardingJDBC帮我们进行的数据库的分库分表操作。</p> <p><a data-fancybox="" title="mysql" href="./image/mysql46.jpg"><img src="/assets/img/mysql46.7341b6aa.jpg" alt="mysql"></a></p> <hr> <h2 id="_4-5-快速实战-inline"><a href="#_4-5-快速实战-inline" class="header-anchor">#</a> 4.5 快速实战-inline</h2> <p><strong>inline分片策略</strong></p> <h3 id="_4-5-1-简单分库策略配置"><a href="#_4-5-1-简单分库策略配置" class="header-anchor">#</a> 4.5.1 简单分库策略配置</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#配置多个数据源</span>
<span class="token attr-name">spring.shardingsphere.datasource.names</span><span class="token punctuation">=</span><span class="token attr-value">m1,m2</span>

<span class="token attr-name">spring.shardingsphere.datasource.m1.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># serverTimezone=GMT%2B8 数据库查询时间问题</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3310/tqktest777?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>

<span class="token attr-name">spring.shardingsphere.datasource.m2.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.m2.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token attr-name">spring.shardingsphere.datasource.m2.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3310/tqktest999?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.m2.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.m2.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>

<span class="token comment">#真实表分布，分库，分表</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">m$-&gt;{1..2}.course_$-&gt;{1..2}</span>

<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>

<span class="token comment">#inline分片策略</span>
<span class="token comment">## 这种方式存在的问题是只能存到m1.course_1 m2.course_2两张表</span>
<span class="token comment"># 分表</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">course_$-&gt;{cid%2+1}</span>
<span class="token comment"># 分库</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">m$-&gt;{cid%2+1}</span>
<span class="token comment">#-------------------------</span>
<span class="token attr-name">spring.shardingsphere.props.sql.show</span> <span class="token punctuation">=</span> <span class="token attr-value">true</span>
<span class="token attr-name">spring.main.allow-bean-definition-overriding</span><span class="token punctuation">=</span><span class="token attr-value">true</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_4-5-2-测试案例"><a href="#_4-5-2-测试案例" class="header-anchor">#</a> 4.5.2  测试案例</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJDBCTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">CourseMapper</span> courseMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 取模分片策略
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Course</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Course</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            c.setCid(Long.valueOf(i));</span>
            c<span class="token punctuation">.</span><span class="token function">setCname</span><span class="token punctuation">(</span><span class="token string">&quot;shardingsphere&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">setCstatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            courseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询测试
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//select * from course</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        wrapper.eq(&quot;cid&quot;,676015284523372545L);</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> cidList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015284523372545L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015286452752385L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015284829556736L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">,</span> cidList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> courses <span class="token operator">=</span> courseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询结果：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        courses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>course <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>course<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_4-5-3-测试结果"><a href="#_4-5-3-测试结果" class="header-anchor">#</a> 4.5.3 测试结果</h3> <p><a data-fancybox="" title="mysql" href="./image/mysql47.jpg"><img src="/assets/img/mysql47.37718fdc.jpg" alt="mysql"></a></p> <div class="language-log line-numbers-mode"><pre class="language-text"><code>查询结果：
Course{cid=676015286452752385, cname='shardingsphere', userId=1009, cstatus='1'}
Course{cid=676015284829556736, cname='shardingsphere', userId=1006, cstatus='1'}
Course{cid=676015284523372545, cname='shardingsphere', userId=1005, cstatus='1'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr> <p><strong>inline无法支持between范围查询</strong></p> <h2 id="_4-6-快速实战-standard"><a href="#_4-6-快速实战-standard" class="header-anchor">#</a> 4.6 快速实战-standard</h2> <h3 id="_4-6-1-配置文件"><a href="#_4-6-1-配置文件" class="header-anchor">#</a> 4.6.1 配置文件</h3> <p><strong>standard支持between范围查询</strong></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#standard标准分片策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.standard.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token comment"># 表精准查询算法</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.standard.precise-algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyPreciseTableShardingAlgorithm</span>
<span class="token comment"># 表范围查询算法</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.standard.range-algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyRangeTableShardingAlgorithm</span>

<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.standard.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">cid</span>
<span class="token comment"># 库精准查询算法</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.standard.precise-algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyPreciseDSShardingAlgorithm</span>
<span class="token comment"># 库范围查询算法</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.standard.range-algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyRangeDSShardingAlgorithm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-6-2-自定义分片策略"><a href="#_4-6-2-自定义分片策略" class="header-anchor">#</a> 4.6.2 自定义分片策略</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">PreciseShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">PreciseShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author
 * @date ：
 * @description:库精准查询算法
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPreciseDSShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//select * from course where cid = ? or cid in (?,?)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cid <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> cidValue <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 实现 course_$-&gt;{cid%2+1)</span>
        <span class="token class-name">BigInteger</span> shardingValueB <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>cidValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigInteger</span> resB <span class="token operator">=</span> <span class="token punctuation">(</span>shardingValueB<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 库名</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;m&quot;</span><span class="token operator">+</span>resB<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>availableTargetNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> key<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//todo couse_1, course_2</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;route &quot;</span><span class="token operator">+</span> key <span class="token operator">+</span><span class="token string">&quot; is not supported ,please check your config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><hr> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">PreciseShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">PreciseShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：
 * @date ：
 * @description: 表精准查询算法
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPreciseTableShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//select * from course where cid = ? or cid in (?,?)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 获取列名</span>
        <span class="token class-name">String</span> cid <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> cidValue <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//todo 实现 course_$-&gt;{cid%2+1) 取模运算</span>
        <span class="token class-name">BigInteger</span> shardingValueB <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>cidValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigInteger</span> resB <span class="token operator">=</span> <span class="token punctuation">(</span>shardingValueB<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> logicTableName<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span>resB<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>availableTargetNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> key<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//todo couse_1, course_2</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;route &quot;</span><span class="token operator">+</span> key <span class="token operator">+</span><span class="token string">&quot; is not supported ,please check your config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><hr> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">RangeShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">RangeShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：
 * @date ：
 * @description:库范围查询算法
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRangeDSShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">RangeShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">RangeShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//todo select * from course where cid between 1 and 100;</span>
        <span class="token class-name">Long</span> upperVal <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValueRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upperEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//100</span>
        <span class="token class-name">Long</span> lowerVal <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValueRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lowerEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>

        <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;m1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;m2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><hr> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">RangeShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">RangeShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：
 * @date ：Created in 2021/1/6
 * @description:表范围查询算法
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRangeTableShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">RangeShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">RangeShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//todo select * from course where cid between 1 and 100; 范围查询</span>
<span class="token comment">//        Long upperVal = shardingValue.getValueRange().upperEndpoint();//100</span>
<span class="token comment">//        Long lowerVal = shardingValue.getValueRange().lowerEndpoint();//1</span>
        <span class="token comment">//todo 设置表名策略</span>
        <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>logicTableName<span class="token operator">+</span><span class="token string">&quot;_1&quot;</span><span class="token punctuation">,</span>logicTableName<span class="token operator">+</span><span class="token string">&quot;_2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><hr> <h3 id="_4-6-3-测试"><a href="#_4-6-3-测试" class="header-anchor">#</a> 4.6.3 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 查询测试
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//select * from course</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        wrapper.eq(&quot;cid&quot;,676015284523372545L);</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> cidList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015284523372545L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015286452752385L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cidList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">676015284829556736L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">,</span> cidList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> courses <span class="token operator">=</span> courseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询结果：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        courses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>course <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>course<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 范围查询
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryOrderRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//select * from course</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">,</span><span class="token number">676021369531535361L</span><span class="token punctuation">,</span><span class="token number">676021372056506369L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        wrapper.in()</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> courses <span class="token operator">=</span> courseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        courses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>course <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>course<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><strong>该种方式会每张表都进行一次范围查询</strong></p> <hr> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 14:17:55.693  INFO 36988 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: SELECT  cid,cname,user_id,cstatus  FROM course_1  
 WHERE  cid BETWEEN ? AND ? ::: [676021369531535361, 676021372056506369]
2021-12-10 14:17:55.693  INFO 36988 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: SELECT  cid,cname,user_id,cstatus  FROM course_2  
 WHERE  cid BETWEEN ? AND ? ::: [676021369531535361, 676021372056506369]
2021-12-10 14:17:55.693  INFO 36988 --- [           main] ShardingSphere-SQL                       : Actual SQL: m2 ::: SELECT  cid,cname,user_id,cstatus  FROM course_1  
 WHERE  cid BETWEEN ? AND ? ::: [676021369531535361, 676021372056506369]
2021-12-10 14:17:55.693  INFO 36988 --- [           main] ShardingSphere-SQL                       : Actual SQL: m2 ::: SELECT  cid,cname,user_id,cstatus  FROM course_2  
 WHERE  cid BETWEEN ? AND ? ::: [676021369531535361, 676021372056506369]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-7-快速实战-complex-复杂分片策略"><a href="#_4-7-快速实战-complex-复杂分片策略" class="header-anchor">#</a> 4.7 快速实战-complex--复杂分片策略</h2> <h3 id="_4-7-1-配置文件"><a href="#_4-7-1-配置文件" class="header-anchor">#</a> 4.7.1 配置文件</h3> <p><strong>complex--复杂分片策略</strong></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#complex--复杂分片策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.complex.sharding-columns</span><span class="token punctuation">=</span> <span class="token attr-value">cid, user_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.complex.algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyComplexTableShardingAlgorithm</span>
<span class="token comment">#</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.complex.sharding-columns</span><span class="token punctuation">=</span><span class="token attr-value">cid, user_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.database-strategy.complex.algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyComplexDSShardingAlgorithm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_4-7-2-自定义分片策略"><a href="#_4-7-2-自定义分片策略" class="header-anchor">#</a> 4.7.2 自定义分片策略</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>complex<span class="token punctuation">.</span></span><span class="token class-name">ComplexKeysShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>complex<span class="token punctuation">.</span></span><span class="token class-name">ComplexKeysShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：Complex
 * @date ：
 * @description:数据库分区精准策略
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComplexDSShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">ComplexKeysShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token comment">//todo     SELECT  cid,cname,user_id,cstatus  FROM course</span>
<span class="token comment">//todo     WHERE  cid BETWEEN ? AND ? AND user_id = ?</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">ComplexKeysShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIdCol <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getColumnNameAndShardingValuesMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token operator">:</span> userIdCol<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//todo course_{userID%2+1}</span>
            <span class="token class-name">BigInteger</span> userIdB <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigInteger</span> target <span class="token operator">=</span> <span class="token punctuation">(</span>userIdB<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token operator">+</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><hr> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>complex<span class="token punctuation">.</span></span><span class="token class-name">ComplexKeysShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>complex<span class="token punctuation">.</span></span><span class="token class-name">ComplexKeysShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：Complex
 * @date ：Created in 2021/1/6
 * @description:表分区精准策略
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComplexTableShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">ComplexKeysShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">ComplexKeysShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIdCol <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getColumnNameAndShardingValuesMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token operator">:</span> userIdCol<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//todo course_{userID%2+1} userid取模</span>
            <span class="token class-name">BigInteger</span> userIdB <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigInteger</span> target <span class="token operator">=</span> <span class="token punctuation">(</span>userIdB<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><hr> <h3 id="_4-7-3-测试"><a href="#_4-7-3-测试" class="header-anchor">#</a> 4.7.3 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryCourseComplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token string">&quot;cid&quot;</span><span class="token punctuation">,</span><span class="token number">676090372270592000L</span><span class="token punctuation">,</span><span class="token number">676090376192266240L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span><span class="token number">1008L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        wrapper.in()</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> courses <span class="token operator">=</span> courseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询结果：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        courses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>course <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>course<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 16:20:24.642  INFO 23080 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: SELECT  cid,cname,user_id,cstatus  FROM course_1  
 WHERE  cid BETWEEN ? AND ? AND user_id = ? ::: [676090372270592000, 676090376192266240, 1008]
查询结果：
Course{cid=676090376192266240, cname='shardingsphere', userId=1008, cstatus='1'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr> <h2 id="_4-8-快速实战-hint强制路由策略"><a href="#_4-8-快速实战-hint强制路由策略" class="header-anchor">#</a> 4.8 快速实战-hint强制路由策略</h2> <h3 id="_4-8-1-配置文件"><a href="#_4-8-1-配置文件" class="header-anchor">#</a> 4.8.1 配置文件</h3> <p><strong>hint强制路由策略</strong></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#hint强制路由策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.course.table-strategy.hint.algorithm-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.tqk.algorithem.MyHintTableShardingAlgorithm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_4-7-2-自定义分片策略-2"><a href="#_4-7-2-自定义分片策略-2" class="header-anchor">#</a> 4.7.2 自定义分片策略</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tqk<span class="token punctuation">.</span>algorithem</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>hint<span class="token punctuation">.</span></span><span class="token class-name">HintShardingAlgorithm</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>api<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>hint<span class="token punctuation">.</span></span><span class="token class-name">HintShardingValue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ：楼兰
 * @date ：Created in 2021/1/6
 * @description:
 **/</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyHintTableShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">HintShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">HintShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>availableTargetNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;route &quot;</span><span class="token operator">+</span> key <span class="token operator">+</span><span class="token string">&quot; is not supported ,please check your config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><hr> <hr> <h3 id="_4-7-3-测试-2"><a href="#_4-7-3-测试-2" class="header-anchor">#</a> 4.7.3 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * Hint--只查询表course_2
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryCourseByHint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">HintManager</span> hintManager <span class="token operator">=</span> <span class="token class-name">HintManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hintManager<span class="token punctuation">.</span><span class="token function">addTableShardingValue</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Course</span><span class="token punctuation">&gt;</span></span> courses <span class="token operator">=</span> courseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询结果：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        courses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>course <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>course<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hintManager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 16:43:16.674  INFO 37512 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: SELECT  cid,cname,user_id,cstatus  FROM course_2
2021-12-10 16:43:16.674  INFO 37512 --- [           main] ShardingSphere-SQL                       : Actual SQL: m2 ::: SELECT  cid,cname,user_id,cstatus  FROM course_2
查询结果：
Course{cid=676090373243670529, cname='shardingsphere', userId=1001, cstatus='1'}
Course{cid=676090374103502849, cname='shardingsphere', userId=1003, cstatus='1'}
Course{cid=676090375072387073, cname='shardingsphere', userId=1005, cstatus='1'}
Course{cid=676090375777030145, cname='shardingsphere', userId=1007, cstatus='1'}
Course{cid=676090376494256129, cname='shardingsphere', userId=1009, cstatus='1'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr> <h2 id="_4-9-广播表"><a href="#_4-9-广播表" class="header-anchor">#</a> 4.9 广播表</h2> <h3 id="_4-9-1-配置信息"><a href="#_4-9-1-配置信息" class="header-anchor">#</a> 4.9.1 配置信息</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#广播表配置</span>
<span class="token attr-name">spring.shardingsphere.sharding.broadcast-tables</span><span class="token punctuation">=</span><span class="token attr-value">t_dict,t_user</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">dict_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-9-2-测试"><a href="#_4-9-2-测试" class="header-anchor">#</a> 4.9.2 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Dict</span> d1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d1<span class="token punctuation">.</span><span class="token function">setUstatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d1<span class="token punctuation">.</span><span class="token function">setUvalue</span><span class="token punctuation">(</span><span class="token string">&quot;正常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dictMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Dict</span> d2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d2<span class="token punctuation">.</span><span class="token function">setUstatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d2<span class="token punctuation">.</span><span class="token function">setUvalue</span><span class="token punctuation">(</span><span class="token string">&quot;不正常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dictMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>d2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><a data-fancybox="" title="mysql" href="./image/mysql48.jpg"><img src="/assets/img/mysql48.ac409bc2.jpg" alt="mysql"></a></p> <h2 id="_4-10-绑定表"><a href="#_4-10-绑定表" class="header-anchor">#</a> 4.10 绑定表</h2> <h3 id="_4-10-1-配置信息"><a href="#_4-10-1-配置信息" class="header-anchor">#</a> 4.10.1 配置信息</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">spring.shardingsphere.datasource.names</span><span class="token punctuation">=</span><span class="token attr-value">m1</span>

<span class="token attr-name">spring.shardingsphere.datasource.m1.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># serverTimezone=GMT%2B8 数据库查询时间问题</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3310/tqktest777?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.m1.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>


<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">m1.t_dict_$-&gt;{1..2}</span>

<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">dict_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token comment">#inline分片策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">ustatus</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.table-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">t_dict_$-&gt;{ustatus.toInteger()%2+1}</span>

<span class="token attr-name">spring.shardingsphere.sharding.tables.user.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">m1.t_user_$-&gt;{1..2}</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.user.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">user_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.user.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.user.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token comment">#inline分片策略</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.user.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token attr-value">ustatus</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.user.table-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token attr-value">t_user_$-&gt;{ustatus.toInteger()%2+1}</span>

<span class="token comment">#绑定表示例</span>
<span class="token attr-name">spring.shardingsphere.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token attr-value">user,t_dict</span>

<span class="token attr-name">spring.shardingsphere.props.sql.show</span> <span class="token punctuation">=</span> <span class="token attr-value">true</span>
<span class="token attr-name">spring.main.allow-bean-definition-overriding</span><span class="token punctuation">=</span><span class="token attr-value">true</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_4-10-2-测试类"><a href="#_4-10-2-测试类" class="header-anchor">#</a> 4.10.2 测试类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select u.user_id,u.username,d.uvalue ustatus from user u left join t_dict d on u.ustatus = d.ustatus&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryUserStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
    * 绑定表示例
    */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryUserStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">queryUserStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="卡笛尔效应"><a href="#卡笛尔效应" class="header-anchor">#</a> 卡笛尔效应</h4> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#绑定表示例 不加改配置时</span>
<span class="token attr-name">spring.shardingsphere.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token attr-value">user,t_dict</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><a data-fancybox="" title="mysql" href="./image/mysql49.jpg"><img src="/assets/img/mysql49.477a9efc.jpg" alt="mysql"></a></p> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 17:27:51.647  INFO 36056 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_2 u left join t_dict_1 d on u.ustatus = d.ustatus
2021-12-10 17:27:51.647  INFO 36056 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_2 u left join t_dict_2 d on u.ustatus = d.ustatus
2021-12-10 17:27:51.647  INFO 36056 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_1 u left join t_dict_1 d on u.ustatus = d.ustatus
2021-12-10 17:27:51.647  INFO 36056 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_1 u left join t_dict_2 d on u.ustatus = d.ustatus
User{userId=676116140073684993, username='user No 1', ustatus='null', uage=0}
User{userId=676116140878991361, username='user No 3', ustatus='null', uage=0}
User{userId=676116141512331265, username='user No 5', ustatus='null', uage=0}
User{userId=676116142196002817, username='user No 7', ustatus='null', uage=0}
User{userId=676116142804176897, username='user No 9', ustatus='null', uage=0}
User{userId=676116140073684993, username='user No 1', ustatus='正常', uage=0}
User{userId=676116140878991361, username='user No 3', ustatus='正常', uage=0}
User{userId=676116141512331265, username='user No 5', ustatus='正常', uage=0}
User{userId=676116142196002817, username='user No 7', ustatus='正常', uage=0}
User{userId=676116142804176897, username='user No 9', ustatus='正常', uage=0}
User{userId=676116139725557760, username='user No 0', ustatus='不正常', uage=0}
User{userId=676116140484726784, username='user No 2', ustatus='不正常', uage=0}
User{userId=676116141189369856, username='user No 4', ustatus='不正常', uage=0}
User{userId=676116141839486976, username='user No 6', ustatus='不正常', uage=0}
User{userId=676116142460243968, username='user No 8', ustatus='不正常', uage=0}
User{userId=676116139725557760, username='user No 0', ustatus='null', uage=0}
User{userId=676116140484726784, username='user No 2', ustatus='null', uage=0}
User{userId=676116141189369856, username='user No 4', ustatus='null', uage=0}
User{userId=676116141839486976, username='user No 6', ustatus='null', uage=0}
User{userId=676116142460243968, username='user No 8', ustatus='null', uage=0}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><hr> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#绑定表示例 加该配置时</span>
<span class="token attr-name">spring.shardingsphere.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token attr-value">user,t_dict</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr> <div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 17:35:15.713  INFO 18336 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_1 u left join t_dict_1 d on u.ustatus = d.ustatus
2021-12-10 17:35:15.713  INFO 18336 --- [           main] ShardingSphere-SQL                       : Actual SQL: m1 ::: select u.user_id,u.username,d.uvalue ustatus from t_user_2 u left join t_dict_2 d on u.ustatus = d.ustatus
User{userId=676116139725557760, username='user No 0', ustatus='不正常', uage=0}
User{userId=676116140484726784, username='user No 2', ustatus='不正常', uage=0}
User{userId=676116141189369856, username='user No 4', ustatus='不正常', uage=0}
User{userId=676116141839486976, username='user No 6', ustatus='不正常', uage=0}
User{userId=676116142460243968, username='user No 8', ustatus='不正常', uage=0}
User{userId=676116140073684993, username='user No 1', ustatus='正常', uage=0}
User{userId=676116140878991361, username='user No 3', ustatus='正常', uage=0}
User{userId=676116141512331265, username='user No 5', ustatus='正常', uage=0}
User{userId=676116142196002817, username='user No 7', ustatus='正常', uage=0}
User{userId=676116142804176897, username='user No 9', ustatus='正常', uage=0}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_4-11-读写分离"><a href="#_4-11-读写分离" class="header-anchor">#</a> 4.11 读写分离</h2> <h3 id="_4-11-1-配置信息"><a href="#_4-11-1-配置信息" class="header-anchor">#</a> 4.11.1 配置信息</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#配置主从数据源，要基于MySQL主从架构</span>
<span class="token attr-name">spring.shardingsphere.datasource.names</span><span class="token punctuation">=</span><span class="token attr-value">m0,s0</span>

<span class="token attr-name">spring.shardingsphere.datasource.m0.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.m0.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token attr-name">spring.shardingsphere.datasource.m0.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3310/tqktest777?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.m0.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.m0.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>

<span class="token attr-name">spring.shardingsphere.datasource.s0.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token attr-name">spring.shardingsphere.datasource.s0.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token attr-name">spring.shardingsphere.datasource.s0.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://49.232.21.151:3311/tqktest777?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">spring.shardingsphere.datasource.s0.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.shardingsphere.datasource.s0.password</span><span class="token punctuation">=</span><span class="token attr-value">12345@tqk</span>
<span class="token comment">#读写分离规则， m0 主库，s0 从库</span>
<span class="token attr-name">spring.shardingsphere.sharding.master-slave-rules.ds0.master-data-source-name</span><span class="token punctuation">=</span><span class="token attr-value">m0</span>
<span class="token attr-name">spring.shardingsphere.sharding.master-slave-rules.ds0.slave-data-source-names[0]</span><span class="token punctuation">=</span><span class="token attr-value">s0</span>
<span class="token comment">#基于读写分离的表分片</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.actual-data-nodes</span><span class="token punctuation">=</span><span class="token attr-value">ds0.t_dict</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.column</span><span class="token punctuation">=</span><span class="token attr-value">dict_id</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.type</span><span class="token punctuation">=</span><span class="token attr-value">SNOWFLAKE</span>
<span class="token attr-name">spring.shardingsphere.sharding.tables.t_dict.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>

<span class="token attr-name">spring.shardingsphere.props.sql.show</span> <span class="token punctuation">=</span> <span class="token attr-value">true</span>
<span class="token attr-name">spring.main.allow-bean-definition-overriding</span><span class="token punctuation">=</span><span class="token attr-value">true</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>#基于读写分离的表分片
spring.shardingsphere.sharding.tables.t_dict.actual-data-nodes=ds0.t_dict_$-&gt;{1..2}

spring.shardingsphere.sharding.tables.t_dict.key-generator.column=dict_id
spring.shardingsphere.sharding.tables.t_dict.key-generator.type=SNOWFLAKE
spring.shardingsphere.sharding.tables.t_dict.key-generator.props.worker.id=1

#inline分片策略
# 分表
spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column=dict_id
spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression=course_$-&gt;{dict_id%2+1}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-11-2-测试类"><a href="#_4-11-2-测试类" class="header-anchor">#</a> 4.11.2 测试类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 读写分离
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDictByMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Dict</span> d1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d1<span class="token punctuation">.</span><span class="token function">setUstatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d1<span class="token punctuation">.</span><span class="token function">setUvalue</span><span class="token punctuation">(</span><span class="token string">&quot;正常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dictMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Dict</span> d2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d2<span class="token punctuation">.</span><span class="token function">setUstatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d2<span class="token punctuation">.</span><span class="token function">setUvalue</span><span class="token punctuation">(</span><span class="token string">&quot;不正常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dictMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>d2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 读写分离
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryDictByMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dict</span><span class="token punctuation">&gt;</span></span> dicts <span class="token operator">=</span> dictMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dicts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dict <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-log line-numbers-mode"><pre class="language-text"><code>2021-12-10 17:44:46.961  INFO 10100 --- [           main] ShardingSphere-SQL                       : Actual SQL: s0 ::: SELECT  dict_id,ustatus,uvalue  FROM t_dict
Dict{dictId=676121103369768960, ustatus='1', uvalue='正常'}
Dict{dictId=676121104338653185, ustatus='0', uvalue='不正常'}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/db/fenkufenbiao/MySQL的高可用方案-2.html" class="prev">
        3. MySQL的高可用方案
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.91f727ae.js" defer></script><script src="/assets/js/2.46e95b75.js" defer></script><script src="/assets/js/95.ba72d1bd.js" defer></script>
  </body>
</html>
